<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferranti Effect & Insulator Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark body {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark .bg-white {
            background-color: #2d3748;
        }
        .dark .text-gray-900 {
            color: #e2e8f0;
        }
        .dark .border-gray-300 {
            border-color: #4a5568;
        }
        .dark input, .dark select {
            background-color: #4a5568;
            color: #e2e8f0;
            border-color: #6b7280;
        }
        .dark button:not(.action-btn-delete):not(.primary-action-btn) {
            background-color: #4299e1;
            color: white;
        }
        .dark button:not(.action-btn-delete):not(.primary-action-btn):hover {
            background-color: #3182ce;
        }
        .dark .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            font-size: 1.5rem;
            flex-direction: column;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        .dark .modal-content {
            background-color: #2d3748;
            color: #e2e8f0;
            border-color: #4a5568;
        }
        .modal-close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close-button:hover,
        .modal-close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .dark .modal-close-button:hover,
        .dark .modal-close-button:focus {
            color: #fff;
        }

        /* Specific styles for tabs and step content */
        .tab-button.active {
            background-color: #cbd5e0; /* Light gray for active tab */
            border-bottom: 2px solid #3b82f6; /* Blue indicator */
        }
        .dark .tab-button.active {
            background-color: #4a5568;
            border-bottom: 2px solid #63b3ed;
        }
        .hidden-step-content {
            display: none !important;
        }
        .user-calc-feedback.correct {
            color: #2ecc71; /* Green */
        }
        .user-calc-feedback.incorrect {
            color: #e74c3c; /* Red */
        }
        .action-btn {
            background-color: #3b82f6;
            color: white;
        }
        .action-btn:hover {
            background-color: #2563eb;
        }
        .action-btn-delete {
            background-color: #ef4444;
            color: white;
        }
        .action-btn-delete:hover {
            background-color: #dc2626;
        }
        table th, table td {
            padding: 8px;
            border: 1px solid #e2e8f0;
            text-align: left;
        }
        .dark table th, .dark table td {
            border: 1px solid #4a5568;
        }
        table th {
            background-color: #edf2f7;
        }
        .dark table th {
            background-color: #2d3748;
        }
        .guidance-panel {
            border-left: 5px solid #3b82f6;
            background-color: #e0f2fe;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .dark .guidance-panel {
            border-left-color: #63b3ed;
            background-color: #2a4365;
        }
        .comparison-item {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .dark .comparison-item {
            border-color: #4a5568;
            background-color: #2d3748;
        }

        /* Insulator specific styles */
        #insulator-string-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            min-height: 150px;
            flex-wrap: wrap; /* Allow wrapping for smaller screens */
        }
        .dark #insulator-string-wrapper { border-color: #444; }

        #insulator-string {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 10px 0;
        }

        .disc {
            width: 60px; /* Increased width for better visibility */
            height: 100px; /* Increased height for better visibility */
            border-radius: 10px; /* More rounded corners */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* Stronger shadow */
            color: white;
            font-weight: bold;
            font-size: 0.8em; /* Slightly larger font */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            user-select: none;
            background: linear-gradient(145deg, #3498db, #2980b9); /* Default Gradient background */
            border: 2px solid #ffffff; /* White border for definition */
            box-sizing: border-box;
            flex-shrink: 0; /* Prevent discs from shrinking */
            cursor: pointer; /* Make discs clickable */
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .disc:hover {
            transform: scale(1.05);
        }
        /* Style for fault/damaged disc */
        .disc.faulty {
            background: linear-gradient(145deg, #e74c3c, #c0392b) !important; /* Red for fault, !important to override dynamic color */
            animation: spark 0.5s infinite alternate;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.7);
        }
        @keyframes spark {
            from { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
            to { box-shadow: 0 0 20px rgba(255, 100, 100, 1); }
        }
        .disc.punctured {
            background: linear-gradient(145deg, #7f8c8d, #34495e) !important; /* Grey/Dark for punctured */
            color: #bdc3c7;
            text-decoration: line-through;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        /* Voltage Flow Animation */
        @keyframes voltage-pulse {
            0% { box-shadow: 0 0 5px rgba(255, 255, 255, 0.4); }
            50% { box-shadow: 0 0 15px rgba(255, 255, 255, 0.8); }
            100% { box-shadow: 0 0 5px rgba(255, 255, 255, 0.4); }
        }
        .disc.voltage-flow-active {
            animation-name: voltage-pulse;
            animation-iteration-count: infinite;
            animation-timing-function: ease-in-out;
        }

        .connector-svg {
            width: 20px;
            height: 100px; /* Adjusted height for larger discs */
            overflow: visible;
        }
        .connector-path {
            stroke: #aaa;
            stroke-width: 2;
            fill: none;
        }
        .dark .connector-path { stroke: #666; }

        .comparison-disc-string {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px auto;
            border: 1px dashed #ccc;
            padding: 5px;
            border-radius: 5px;
            max-width: 200px; /* Constrain width for comparison */
        }
        .comparison-disc-string .disc {
            width: 40px;
            height: 70px;
            font-size: 0.7em;
        }
        .comparison-disc-string .connector-svg {
            height: 70px;
        }

        #designModeContent {
            padding: 15px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            margin-top: 15px;
            background-color: #f9f9f9;
        }
        .dark #designModeContent {
            background-color: #333;
            border-color: #555;
        }
        #designModeContent h4 {
            margin-top: 0;
            color: #2c3e50;
        }
        .dark #designModeContent h4 {
            color: #e0e0e0;
        }
        #designModeResult {
            margin-top: 10px;
            font-weight: bold;
            color: #27ae60;
        }
        .dark #designModeResult {
            color: #2ecc71;
        }

        #personalizedFeedback {
            margin-top: 15px;
            padding: 10px;
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 44px;
            font-style: italic;
        }
        .dark #personalizedFeedback {
            background-color: #2c3e50;
            border-color: #3498db;
            color: #ecf0f1;
        }

        .current-run-data-table {
            margin-top: 20px;
        }
        .current-run-data-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .current-run-data-table th, .current-run-data-table td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: left;
        }
        .dark .current-run-data-table th, .dark .current-run-data-table td {
            border-color: #4a5568;
        }
        .current-run-data-table th {
            background-color: #edf2f7;
        }
        .dark .current-run-data-table th {
            background-color: #2d3748;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 flex flex-col items-center p-4 min-h-screen">

    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p>Calculating...</p>
    </div>

    <div id="customAlertModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" onclick="document.getElementById('customAlertModal').style.display='none'">&times;</span>
            <p id="customAlertMessage" class="text-lg my-4"></p>
            <button onclick="document.getElementById('customAlertModal').style.display='none'" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">OK</button>
        </div>
    </div>

    <div id="customConfirmModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" onclick="document.getElementById('customConfirmModal').style.display='none'">&times;</span>
            <p id="customConfirmMessage" class="text-lg my-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirmYesBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Yes</button>
                <button onclick="document.getElementById('customConfirmModal').style.display='none'" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">No</button>
            </div>
        </div>
    </div>

    <div id="discPropertiesModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" onclick="document.getElementById('discPropertiesModal').style.display='none'">&times;</span>
            <h2 id="discPropertiesModalTitle" class="text-xl font-bold mb-4">Disc Properties: <span id="modalDiscIndex"></span></h2>
            <p class="text-lg mb-4">Voltage: <span id="modalDiscVoltage"></span> kV</p>
            <label class="flex items-center justify-center space-x-2 mb-4">
                <input type="checkbox" id="isPuncturedCheckbox" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                <span class="text-gray-700 dark:text-gray-300">Punctured (Disc is electrically ineffective)</span>
            </label>
            <button id="saveDiscPropertiesBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Save Changes</button>
        </div>
    </div>

    <div id="faultSettingsModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" onclick="document.getElementById('faultSettingsModal').style.display='none'">&times;</span>
            <h2 id="faultSettingsModalTitle" class="text-xl font-bold mb-4">‚ö° Advanced Fault Settings</h2>
            <p class="text-gray-700 dark:text-gray-300 mb-4">Configure parameters for simulating fault conditions on the insulator string.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="flex flex-col">
                    <label for="modalFaultVoltage" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fault Voltage (kV):</label>
                    <input type="number" id="modalFaultVoltage" min="0" max="1000" value="0" step="10" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex flex-col">
                    <label for="modalFaultDuration" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fault Duration (ms):</label>
                    <input type="number" id="modalFaultDuration" min="0" max="5000" value="0" step="100" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex flex-col md:col-span-2">
                    <label for="modalFaultyDiscIndex" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Faulty Disc Index (1-based from line end, 0 for none):</label>
                    <input type="number" id="modalFaultyDiscIndex" min="0" max="20" value="0" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="flex justify-center space-x-4">
                <button id="saveFaultSettingsBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Save Fault Settings</button>
                <button onclick="document.getElementById('faultSettingsModal').style.display='none'" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Cancel</button>
            </div>
        </div>
    </div>


    <div class="container max-w-5xl w-full bg-white p-8 rounded-lg shadow-lg mb-8">
        <div class="flex justify-end mb-4">
            <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" id="darkModeToggle" class="sr-only peer">
                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                <span class="text-sm font-medium text-gray-900 dark:text-gray-300">Dark Mode</span>
            </label>
        </div>

        <h1 class="text-3xl font-bold text-center mb-6 text-blue-700 dark:text-blue-400">Ferranti Effect & Insulator Simulation</h1>

        <div class="flex justify-center border-b border-gray-300 dark:border-gray-600 mb-6 flex-wrap">
            <button class="tab-button px-4 py-2 text-lg font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition duration-300 ease-in-out active" onclick="openTab(event, 'ferrantiEffect')">Ferranti Effect</button>
            <button class="tab-button px-4 py-2 text-lg font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition duration-300 ease-in-out" onclick="openTab(event, 'insulatorSimulation')">Insulator Voltage Distribution</button>
            <button class="tab-button px-4 py-2 text-lg font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition duration-300 ease-in-out" onclick="openTab(event, 'experimentHistory')">Experiment History</button>
            <button class="tab-button px-4 py-2 text-lg font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition duration-300 ease-in-out" onclick="openTab(event, 'analyticsDashboard')">Analytics Dashboard</button>
            <button class="tab-button px-4 py-2 text-lg font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition duration-300 ease-in-out" onclick="openTab(event, 'comparisonView')">Comparison View</button>
        </div>

        <div id="ferrantiEffect" class="tab-panel active">
            <div class="guidance-panel">
                <h3 id="ferrantiStepTitle" class="text-xl font-semibold text-blue-700 dark:text-blue-400 mb-2">Welcome!</h3>
                <p id="ferrantiStepInstruction" class="text-gray-700 dark:text-gray-300">This guided simulation will help you understand the Ferranti Effect. Click "Start Experiment" to begin.</p>
            </div>

            <div id="ferrantiStepWelcomeContent" class="step-content">
                <div class="flex justify-center mt-6">
                    <button id="ferrantiStartExperimentBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                        Start Experiment
                    </button>
                </div>
            </div>

            <div id="ferrantiStepParametersContent" class="step-content hidden-step-content">
                <h2 class="text-2xl font-bold text-center mb-4 text-blue-700 dark:text-blue-400">Step 1: Set Parameters</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="flex flex-col">
                        <label for="lineLength" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Line Length (km):</label>
                        <input type="number" id="lineLength" value="300" min="1" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex flex-col">
                        <label for="resistance" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Resistance (Œ©/km):</label>
                        <input type="number" id="resistance" value="0.1" step="0.01" min="0" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex flex-col">
                        <label for="inductance" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Inductance (mH/km):</label>
                        <input type="number" id="inductance" value="1.0" step="0.01" min="0" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex flex-col">
                        <label for="capacitance" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Capacitance (nF/km):</label>
                        <input type="number" id="capacitance" value="0.01" step="0.001" min="0" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex flex-col">
                        <label for="frequency" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Frequency (Hz):</label>
                        <input type="number" id="frequency" value="50" min="1" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex flex-col">
                        <label for="sendingVoltage" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sending End Voltage (kV):</label>
                        <input type="number" id="sendingVoltage" value="220" min="1" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex flex-col md:col-span-2">
                        <label for="loadCondition" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Load Condition:</label>
                        <select id="loadCondition" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="noLoad">No Load (Open Circuit)</option>
                            <option value="lightLoad">Light Load (High Resistance)</option>
                        </select>
                    </div>
                    <div class="flex flex-col md:col-span-2">
                        <label for="shuntReactorXL" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Shunt Reactor Inductive Reactance (XL, Œ©) at Receiving End (0 for none):</label>
                        <input type="number" id="shuntReactorXL" value="0" min="0" step="10" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="flex justify-center space-x-4 mt-6">
                    <button id="ferrantiParamsToReviewBtn" class="action-btn py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                        Confirm Parameters
                    </button>
                    <button id="ferrantiLoadDefaultParamsBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                        Load Default
                    </button>
                </div>
            </div>

            <div id="ferrantiStepReviewDataContent" class="step-content hidden-step-content">
                <h2 class="text-2xl font-bold text-center mb-4 text-blue-700 dark:text-blue-400">Step 2: Review Entered Data</h2>
                <div id="ferrantiEnteredDataDisplay" class="text-lg mb-8 p-4 border border-gray-300 dark:border-gray-600 rounded-md">
                    </div>
                <div class="flex justify-center space-x-4 mt-6">
                    <button id="ferrantiReviewToTheoryBtn" class="action-btn py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                        Proceed to Theory
                    </button>
                    <button id="ferrantiReviewToParamsBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                        Back to Parameters
                    </button>
                </div>
            </div>

            <div id="ferrantiStepTheoryContent" class="step-content hidden-step-content">
                <h2 class="text-2xl font-bold text-center mb-4 text-blue-700 dark:text-blue-400">Step 3: Theoretical Background</h2>
                <div class="text-gray-700 dark:text-gray-300 text-left mb-8 p-4 border border-gray-300 dark:border-gray-600 rounded-md">
                    <p class="mb-4">The **Ferranti Effect** is a phenomenon in long transmission lines where the receiving-end voltage ($V_R$) becomes greater than the sending-end voltage ($V_S$) under light or no-load conditions. This occurs due to the line's distributed capacitance, which draws a leading charging current. This current flows through the line's series inductance, causing a voltage drop that is in phase opposition to the sending-end voltage, effectively boosting the receiving-end voltage.</p>
                    <p class="mb-4">For simulation, we often use the **Nominal Pi ($\pi$) Model** to represent the transmission line. In this model, the total series impedance ($Z = R + j\omega L$) is placed in the middle, and half of the total shunt admittance ($Y = j\omega C$) is placed at each end.</p>
                    <p class="mb-4">The relationship between sending-end and receiving-end voltages and currents can be described using **ABCD parameters**:</p>
                    <p class="text-center text-xl font-mono my-4">
                        $V_S = A V_R + B I_R$ <br>
                        $I_S = C V_R + D I_R$
                    </p>
                    <p class="mb-4">For a symmetrical Nominal Pi model:</p>
                    <p class="text-center my-2">
                        $A = D = 1 + \frac{ZY}{2}$ <br>
                        $B = Z$ <br>
                        $C = Y(1 + \frac{ZY}{4})$
                    </p>
                    <p class="mb-4">Under **no-load** conditions, $I_R = 0$, so $V_S = A V_R$ and $I_S = C V_R$. Thus, $V_R = V_S / A$. Since 'A' can have a magnitude less than 1 for long lines, $V_R$ can be greater than $V_S$.</p>
                    <p class="mb-4">A **shunt reactor** can be connected at the receiving end to absorb the excess reactive power generated by the line's capacitance, thereby reducing or eliminating the Ferranti effect.</p>
                </div>
                <div class="flex justify-center space-x-4 mt-6">
                    <button id="ferrantiTheoryToUserCalcBtn" class="action-btn py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                        Proceed to Self-Calculation
                    </button>
                    <button id="ferrantiTheoryToReviewBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                        Back to Review Data
                    </button>
                </div>
            </div>

            <div id="ferrantiStepUserCalculationContent" class="step-content hidden-step-content">
                <h2 class="text-2xl font-bold text-center mb-4 text-blue-700 dark:text-blue-400">Step 4: Your Turn to Calculate!</h2>
                <p class="text-gray-700 dark:text-gray-300 text-center mb-4">Based on the parameters and theory, try to estimate the Receiving End Voltage (Vr) and the Voltage Rise percentage. Enter your estimates below.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="flex flex-col">
                        <label for="userVr" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Your Estimated Receiving End Voltage (Vr, kV):</label>
                        <input type="number" id="userVr" step="0.1" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex flex-col">
                        <label for="userVoltageRise" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Your Estimated Voltage Rise (%):</label>
                        <input type="number" id="userVoltageRise" step="0.1" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div id="ferrantiUserCalculationFeedback" class="user-calc-feedback text-center text-lg font-semibold mb-6" role="status" aria-live="polite"></div>
                <div class="flex justify-center space-x-4 mt-6">
                    <button id="ferrantiCheckUserCalculationBtn" class="action-btn py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                        Check My Calculation
                    </button>
                    <button id="ferrantiSkipCalculationBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                        Skip Calculation
                    </button>
                    <button id="ferrantiUserCalcToSimulateBtn" class="action-btn py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out hidden-step-content">
                        Proceed to Simulation
                    </button>
                </div>
            </div>

            <div id="ferrantiStepResultsContent" class="step-content hidden-step-content">
                <h2 class="text-2xl font-bold text-center mb-4 text-blue-700 dark:text-blue-400">Step 5: Simulation & Results</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-lg mb-8 p-4 border border-gray-300 dark:border-gray-600 rounded-md">
                    <p class="font-semibold">Sending End Voltage (Vs): <span id="displayVs" class="font-normal"></span> kV</p>
                    <p class="font-semibold">Receiving End Voltage (Vr): <span id="displayVr" class="font-normal"></span> kV</p>
                    <p class="font-semibold">Voltage Rise (%): <span id="displayVoltageRise" class="font-normal"></span> %</p>
                    <p class="font-semibold">Sending End Current (Is): <span id="displayIs" class="font-normal"></span> A</p>
                    <p class="font-semibold">Receiving End Current (Ir): <span id="displayIr" class="font-normal"></span> A</p>
                    <p class="font-semibold">Shunt Reactor XL: <span id="displayShuntReactorXL" class="font-normal"></span> Œ©</p>
                </div>

                <div id="voltageProfileChart" class="w-full h-96 bg-gray-50 dark:bg-gray-800 rounded-md shadow-inner mb-8"></div>

                <div class="flex justify-center space-x-4 mt-6">
                    <button id="ferrantiResultsToAnalysisBtn" class="action-btn py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                        Analyze & Experiment
                    </button>
                    <button id="ferrantiSaveExperimentBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                        üíæ Save Experiment
                    </button>
                </div>
            </div>

            <div id="ferrantiStepAnalysisContent" class="step-content hidden-step-content">
                <h2 class="text-2xl font-bold text-center mb-4 text-blue-700 dark:text-blue-400">Step 6: Analysis & Experimentation</h2>
                <div class="text-gray-700 dark:text-gray-300 text-left mb-8 p-4 border border-gray-300 dark:border-gray-600 rounded-md">
                    <p class="mb-2">You've completed a simulation! Here are some points to consider:</p>
                    <ul class="list-disc list-inside ml-4">
                        <li>Observe the voltage profile: Is $V_R$ higher than $V_S$? How does the voltage change along the line?</li>
                        <li>How does line length, frequency, and capacitance affect the Ferranti effect?</li>
                        <li>Experiment with adding a shunt reactor in the previous step (Step 1) to see how it mitigates the voltage rise.</li>
                        <li>Check the 'Experiment History' and 'Analytics Dashboard' tabs to review past runs and identify trends.</li>
                    </ul>
                </div>
                <div class="flex justify-center space-x-4 mt-6">
                    <button id="ferrantiAnalysisToParamsBtn" class="action-btn py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                        New Experiment (Adjust Parameters)
                    </button>
                    <button onclick="openTab(event, 'experimentHistory')" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                        Go to History
                    </button>
                    <button onclick="openTab(event, 'analyticsDashboard')" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                        Go to Analytics
                    </button>
                </div>
            </div>

            <div class="flex justify-center space-x-4 mt-10 pt-6 border-t border-gray-200 dark:border-gray-700">
                <button id="ferrantiResetGlobalBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                    üîÑ Reset Entire Flow
                </button>
            </div>
        </div>

        <div id="insulatorSimulation" class="tab-panel hidden">
            <div class="guidance-panel">
                <h3 id="insulatorStepTitle" class="text-xl font-semibold text-blue-700 dark:text-blue-400 mb-2">Welcome!</h3>
                <p id="insulatorStepInstruction" class="text-gray-700 dark:text-gray-300">This section simulates voltage distribution across an insulator string. Adjust parameters and observe the voltage across each disc and the string efficiency.</p>
            </div>

            <div id="insulatorStepParametersContent" class="step-content">
                <h2 class="text-2xl font-bold text-center mb-4 text-blue-700 dark:text-blue-400">Step 1: Set Insulator Parameters</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="flex flex-col">
                        <label for="insulatorNumDiscs" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Number of Discs (n):</label>
                        <input type="number" id="insulatorNumDiscs" value="5" min="1" max="20" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex flex-col">
                        <label for="insulatorTotalVoltage" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Total Voltage (kV):</label>
                        <input type="number" id="insulatorTotalVoltage" value="100" min="10" max="500" step="10" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex flex-col">
                        <label for="insulatorCs" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Shunt Cap. Cs (nF):</label>
                        <input type="number" id="insulatorCs" value="0.5" step="0.01" min="0.01" max="5" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex flex-col">
                        <label for="insulatorCm" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Mutual Cap. Cm (nF):</label>
                        <input type="number" id="insulatorCm" value="1.0" step="0.1" min="0.1" max="5" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div class="flex flex-col">
                        <label for="insulatorMaterial" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Insulator Material:</label>
                        <select id="insulatorMaterial" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="porcelain">Porcelain</option>
                            <option value="glass">Glass</option>
                            <option value="composite">Composite</option>
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="pollutionLevel" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pollution Level:</label>
                        <select id="pollutionLevel" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="none">None</option>
                            <option value="light">Light</option>
                            <option value="medium">Medium</option>
                            <option value="heavy">Heavy</option>
                        </select>
                    </div>
                    <div class="flex flex-col md:col-span-2">
                        <label for="humidity" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Humidity (%):</label>
                        <input type="number" id="humidity" value="50" min="0" max="100" step="1" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="flex justify-center space-x-4 mt-6">
                    <button id="insulatorCalculateBtn" class="action-btn py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">Calculate Voltage Distribution</button>
                    <button id="insulatorLoadDefaultParamsBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">Load Default</button>
                    <button id="openFaultSettingsBtn" class="action-btn py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">‚ö° Advanced Fault Settings</button>
                </div>
                <div id="designModeContent" class="mt-8 p-4 border border-gray-300 dark:border-gray-600 rounded-md hidden">
                    <h4 class="text-xl font-semibold text-blue-700 dark:text-blue-400 mb-4">Design Mode: Suggest Number of Discs</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="flex flex-col">
                            <label for="targetSystemVoltage" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Target System Voltage (kV):</label>
                            <input type="number" id="targetSystemVoltage" value="100" min="10" max="1000" step="10" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="maxVoltagePerDisc" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Max Voltage per Disc (kV):</label>
                            <input type="number" id="maxVoltagePerDisc" value="15" min="1" max="50" step="1" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <button id="calculateDesignBtn" class="action-btn py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">Calculate Discs Needed</button>
                    <p id="designModeResult" class="font-bold text-lg mt-4"></p>
                </div>
                <button id="toggleDesignModeBtn" class="action-btn py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out mt-4">‚öôÔ∏è Design Mode</button>
            </div>

            <div id="insulatorStepResultsContent" class="step-content hidden-step-content">
                <h2 class="text-2xl font-bold text-center mb-4 text-blue-700 dark:text-blue-400">Insulator Results & Analysis</h2>
                <div id="insulator-string-wrapper" class="flex flex-col items-center mt-8 p-4 border border-gray-300 dark:border-gray-600 rounded-md">
                    <h3 class="text-xl font-semibold text-blue-700 dark:text-blue-400 mb-4">Insulator String Visualisation</h3>
                    <div class="flex justify-center items-center gap-2">
                        <div style="font-weight: bold; margin-right: 10px; white-space: nowrap; color: inherit;">Tower End</div>
                        <div id="insulator-string" class="flex justify-center items-center gap-2 overflow-x-auto p-2">
                            </div>
                        <div style="font-weight: bold; margin-left: 10px; white-space: nowrap; color: inherit;">Line End</div>
                    </div>
                    <p id="insulator-efficiency-display" class="font-bold text-lg text-green-600 dark:text-green-400 mt-4">String Efficiency: N/A</p>
                </div>

                <div class="current-run-data-table" style="margin-top: 20px;">
                    <h3 class="text-xl font-semibold text-blue-700 dark:text-blue-400 mb-2">Current Run Disc Voltages</h3>
                    <div style="overflow-x:auto;">
                        <table id="currentRunDataTable" class="min-w-full bg-white dark:bg-gray-700 rounded-md shadow-md">
                            <thead>
                                <tr>
                                    <th>Disc No. (from Line End)</th>
                                    <th>Voltage (kV)</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="insulatorVoltageChart" class="mt-8 p-4 border border-gray-300 dark:border-gray-600 rounded-md" style="height: 350px;"></div>

                <div class="flex justify-center space-x-4 mt-6">
                    <button id="insulatorSaveExperimentBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                        üíæ Save Experiment
                    </button>
                    <button id="toggleVoltageFlowBtn" class="action-btn py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">‚ö° Toggle Voltage Flow</button>
                    <button onclick="openTab(event, 'experimentHistory')" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                        Go to History
                    </button>
                </div>
            </div>

            <div class="flex justify-center space-x-4 mt-10 pt-6 border-t border-gray-200 dark:border-gray-700">
                <button id="insulatorResetGlobalBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                    üîÑ Reset Entire Flow
                </button>
            </div>
        </div>

        <div id="experimentHistory" class="tab-panel hidden">
            <h2 class="text-2xl font-bold text-center mb-4 text-blue-700 dark:text-blue-400">Experiment History</h2>
            <div class="flex justify-center space-x-4 mb-4">
                <input type="text" id="historyNoteInput" placeholder="Add a note for the next saved experiment..." class="p-2 border border-gray-300 rounded-md w-full max-w-md">
                <button id="saveWithNoteBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Save Current Config</button>
            </div>
            <div class="flex justify-center space-x-4 mb-6">
                <button id="exportCsvBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Export to CSV</button>
                <button id="clearHistoryBtn" class="action-btn-delete py-2 px-4 rounded-md">Clear All History</button>
            </div>
            <div class="overflow-x-auto">
                <table id="historyTable" class="min-w-full bg-white dark:bg-gray-700 rounded-md shadow-md">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Type</th>
                            <th>Timestamp</th>
                            <th>Length/Discs</th>
                            <th>R/V_total</th>
                            <th>L/Cs</th>
                            <th>C/Cm</th>
                            <th>Freq/k</th>
                            <th>Vs/Eff</th>
                            <th>Load/MaxV</th>
                            <th>ReactorXL/UserEff</th>
                            <th>Vr/UserDisc1V</th>
                            <th>Rise/Material</th>
                            <th>Is/Pollution</th>
                            <th>Ir/Humidity</th>
                            <th>UserVr/FaultV</th>
                            <th>UserRise/FaultDur</th>
                            <th>PuncturedDiscs</th>
                            <th>Note</th>
                            <th>Actions</th>
                            <th>Compare</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

        <div id="analyticsDashboard" class="tab-panel hidden">
            <h2 class="text-2xl font-bold text-center mb-4 text-blue-700 dark:text-blue-400">Analytics Dashboard</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div id="chartVrVsLength" class="w-full h-80 bg-gray-50 dark:bg-gray-800 rounded-md shadow-inner"></div>
                <div id="chartRiseVsLoad" class="w-full h-80 bg-gray-50 dark:bg-gray-800 rounded-md shadow-inner"></div>
                <div id="chartReactorEffect" class="w-full h-80 bg-gray-50 dark:bg-gray-800 rounded-md shadow-inner"></div>
                <div id="chartUserVsSystemFerranti" class="w-full h-80 bg-gray-50 dark:bg-gray-800 rounded-md shadow-inner"></div>

                <div id="efficiencyVsKGraph" class="w-full h-80 bg-gray-50 dark:bg-gray-800 rounded-md shadow-inner"></div>
                <div id="voltageTrendsGraph" class="w-full h-80 bg-gray-50 dark:bg-gray-800 rounded-md shadow-inner"></div>
                <div id="efficiencyOverTimeGraph" class="w-full h-80 bg-gray-50 dark:bg-gray-800 rounded-md shadow-inner"></div>
                <div id="userVsSystemEfficiencyGraph" class="w-full h-80 bg-gray-50 dark:bg-gray-800 rounded-md shadow-inner"></div>
                <div id="userVsSystemDisc1VoltageGraph" class="w-full h-80 bg-gray-50 dark:bg-gray-800 rounded-md shadow-inner"></div>

                <div class="col-span-1 lg:col-span-2 p-4 border border-gray-300 dark:border-gray-600 rounded-md">
                    <h3 class="text-xl font-semibold text-blue-700 dark:text-blue-400 mb-4">Compare Insulator Voltage Distributions</h3>
                    <label for="compareRunsSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Insulator Experiments to Compare:</label>
                    <select id="compareRunsSelect" multiple size="5" class="p-2 border border-gray-300 rounded-md w-full max-w-md focus:ring-blue-500 focus:border-blue-500 mb-4"></select>
                    <button id="plotComparisonChartBtn" class="action-btn py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">Plot Selected Runs</button>
                    <div id="comparisonVoltageChart" class="w-full h-96 bg-gray-50 dark:bg-gray-800 rounded-md shadow-inner mt-4"></div>
                </div>
            </div>
            <div id="personalizedFeedback" class="mt-8 p-4 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-md">
                Complete a few experiments to see personalized feedback.
            </div>
        </div>

        <div id="comparisonView" class="tab-panel hidden">
            <h2 class="text-2xl font-bold text-center mb-4 text-blue-700 dark:text-blue-400">Experiment Comparison View</h2>
            <p class="text-center text-gray-700 dark:text-gray-300 mb-6">Select up to two experiments from the 'Experiment History' to compare them side-by-side.</p>
            <div id="comparisonContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                </div>
        </div>

        <div class="flex justify-center space-x-4 mt-10 pt-6 border-t border-gray-200 dark:border-gray-700">
            <button id="screenshotBtnGlobal" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                üì∑ Take Screenshot
            </button>
            <button id="printBtnGlobal" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out">
                üñ®Ô∏è Print Current View
            </button>
        </div>
    </div>

    <script type="text/javascript">
        // --- Complex Number Class ---
        class Complex {
            constructor(real, imag) {
                this.real = real;
                this.imag = imag;
            }
            add(other) { return new Complex(this.real + other.real, this.imag + other.imag); }
            subtract(other) { return new Complex(this.real - other.real, this.imag - other.imag); }
            multiply(other) {
                return new Complex(
                    this.real * other.real - this.imag * other.imag,
                    this.real * other.imag + this.imag * other.real
                );
            }
            divide(other) {
                const denominator = other.real * other.real + other.imag * other.imag;
                if (denominator === 0) { console.error("Division by zero complex number."); return new Complex(Infinity, Infinity); }
                return new Complex(
                    (this.real * other.real + this.imag * other.imag) / denominator,
                    (this.imag * other.real - this.real * other.imag) / denominator
                );
            }
            magnitude() { return Math.sqrt(this.real * this.real + this.imag * this.imag); }
            angle() { return Math.atan2(this.imag, this.real); }
            conjugate() { return new Complex(this.real, -this.imag); }
            toString() {
                if (this.imag === 0) return this.real.toFixed(3);
                if (this.real === 0) return this.imag.toFixed(3) + 'j';
                return `${this.real.toFixed(3)} ${this.imag >= 0 ? '+' : '-'} ${Math.abs(this.imag).toFixed(3)}j`;
            }
        }

        // --- DOM Elements (Ferranti Effect) ---
        const lineLengthInput = document.getElementById('lineLength');
        const resistanceInput = document.getElementById('resistance');
        const inductanceInput = document.getElementById('inductance');
        const capacitanceInput = document.getElementById('capacitance');
        const frequencyInput = document.getElementById('frequency');
        const sendingVoltageInput = document.getElementById('sendingVoltage');
        const loadConditionSelect = document.getElementById('loadCondition');
        const shuntReactorXLInput = document.getElementById('shuntReactorXL');

        const ferrantiLoadingOverlay = document.getElementById('loading-overlay');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customConfirmModal = document.getElementById('customConfirmModal');
        const customConfirmMessage = document.getElementById('customConfirmMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');

        // Ferranti Step-by-step UI elements
        const ferrantiStepTitleEl = document.getElementById('ferrantiStepTitle');
        const ferrantiStepInstructionEl = document.getElementById('ferrantiStepInstruction');
        const ferrantiStepContents = document.querySelectorAll('#ferrantiEffect .step-content');
        const ferrantiStepWelcomeContent = document.getElementById('ferrantiStepWelcomeContent');
        const ferrantiStepParametersContent = document.getElementById('ferrantiStepParametersContent');
        const ferrantiStepReviewDataContent = document.getElementById('ferrantiStepReviewDataContent');
        const ferrantiStepTheoryContent = document.getElementById('ferrantiStepTheoryContent');
        const ferrantiStepUserCalculationContent = document.getElementById('ferrantiStepUserCalculationContent');
        const ferrantiStepResultsContent = document.getElementById('ferrantiStepResultsContent');
        const ferrantiStepAnalysisContent = document.getElementById('ferrantiStepAnalysisContent');

        const ferrantiEnteredDataDisplay = document.getElementById('ferrantiEnteredDataDisplay');
        const userVrInput = document.getElementById('userVr');
        const userVoltageRiseInput = document.getElementById('userVoltageRise');
        const ferrantiUserCalculationFeedback = document.getElementById('ferrantiUserCalculationFeedback');
        const ferrantiUserCalcToSimulateBtn = document.getElementById('ferrantiUserCalcToSimulateBtn');

        const displayVs = document.getElementById('displayVs');
        const displayVr = document.getElementById('displayVr');
        const displayVoltageRise = document.getElementById('displayVoltageRise');
        const displayIs = document.getElementById('displayIs');
        const displayIr = document.getElementById('displayIr');
        const displayShuntReactorXL = document.getElementById('displayShuntReactorXL');
        const voltageProfileChartDiv = document.getElementById('voltageProfileChart');

        const historyTableBody = document.querySelector('#historyTable tbody');
        const historyNoteInput = document.getElementById('historyNoteInput');
        const personalizedFeedbackEl = document.getElementById('personalizedFeedback');
        const comparisonContainer = document.getElementById('comparisonContainer');

        // --- DOM Elements (Insulator Simulation) ---
        const insulatorNumDiscsInput = document.getElementById('insulatorNumDiscs');
        const insulatorTotalVoltageInput = document.getElementById('insulatorTotalVoltage');
        const insulatorCsInput = document.getElementById('insulatorCs');
        const insulatorCmInput = document.getElementById('insulatorCm');
        const insulatorMaterialSelect = document.getElementById('insulatorMaterial');
        const pollutionLevelSelect = document.getElementById('pollutionLevel');
        const humidityInput = document.getElementById('humidity');

        const insulatorStringDiv = document.getElementById('insulator-string');
        const insulatorEfficiencyDisplay = document.getElementById('insulator-efficiency-display');
        const insulatorVoltageChartDiv = document.getElementById('insulatorVoltageChart');
        const currentRunDataTableBody = document.querySelector('#currentRunDataTable tbody'); // New reference

        // Insulator Design Mode
        const toggleDesignModeBtn = document.getElementById('toggleDesignModeBtn');
        const designModeContent = document.getElementById('designModeContent');
        const targetSystemVoltageInput = document.getElementById('targetSystemVoltage');
        const maxVoltagePerDiscInput = document.getElementById('maxVoltagePerDisc');
        const calculateDesignBtn = document.getElementById('calculateDesignBtn');
        const designModeResult = document.getElementById('designModeResult');

        // Insulator Fault Settings
        const faultSettingsModal = document.getElementById('faultSettingsModal');
        const openFaultSettingsBtn = document.getElementById('openFaultSettingsBtn');
        const saveFaultSettingsBtn = document.getElementById('saveFaultSettingsBtn');
        const modalFaultVoltageInput = document.getElementById('modalFaultVoltage');
        const modalFaultDurationInput = document.getElementById('modalFaultDuration');
        const modalFaultyDiscIndexInput = document.getElementById('modalFaultyDiscIndex');

        // Insulator Disc Properties
        const discPropertiesModal = document.getElementById('discPropertiesModal');
        const saveDiscPropertiesBtn = document.getElementById('saveDiscPropertiesBtn');
        const isPuncturedCheckbox = document.getElementById('isPuncturedCheckbox');
        const modalDiscIndexSpan = document.getElementById('modalDiscIndex');
        const modalDiscVoltageSpan = document.getElementById('modalDiscVoltage');

        // Insulator Voltage Flow Animation
        const toggleVoltageFlowBtn = document.getElementById('toggleVoltageFlowBtn');

        // Analytics - Comparative Insulator Chart
        const compareRunsSelect = document.getElementById('compareRunsSelect');
        const plotComparisonChartBtn = document.getElementById('plotComparisonChartBtn');
        let comparisonVoltagePlotlyChart = null; // To hold the Plotly chart instance


        // --- Global State Variables ---
        let currentActiveTab = 'ferrantiEffect'; // Tracks which main tab is active
        let ferrantiSimStep = 0; // 0: Welcome, 1: Params, 2: Review, 3: Theory, 4: User Calc, 5: Results, 6: Analysis
        let insulatorSimStep = 0; // 0: Params, 1: Results (simplified for now)
        let experimentHistory = []; // Unified history for both types of experiments
        let experimentIdCounter = 0;
        let currentFerrantiSimulationResults = null;
        let ferrantiUserCalculatedVr = null;
        let ferrantiUserCalculatedRise = null;
        let comparisonExperiments = []; // Stores IDs of experiments selected for comparison (max 2)

        // Insulator specific state
        let insulatorCalculatedVoltages = [];
        let insulatorCalculatedEfficiency = 0;
        let discPuncturedStatus = {}; // Stores { discIndex: isPunctured } for current simulation
        let currentEditedDiscIndex = null; // The index of the disc currently being edited in the modal
        let faultTimeoutId = null; // For fault visualization
        let isVoltageFlowAnimationEnabled = false; // For voltage flow animation

        // --- Default Values ---
        const ferrantiDefaultParams = {
            lineLength: 300, // km
            resistance: 0.1, // Ohm/km
            inductance: 1.0, // mH/km
            capacitance: 0.01, // nF/km
            frequency: 50, // Hz
            sendingVoltage: 220, // kV
            loadCondition: 'noLoad',
            shuntReactorXL: 0 // Ohm
        };

        const insulatorDefaultParams = {
            numDiscs: 5,
            totalVoltage: 100,
            cs: 0.5,
            cm: 1.0,
            insulatorMaterial: 'porcelain',
            pollutionLevel: 'none',
            humidity: 50,
            faultVoltage: 0,
            faultDuration: 0,
            faultyDiscIndex: 0
        };

        const materialProperties = {
            porcelain: { cm_mult: 1.0, cs_mult: 1.0, base_efficiency_impact: 0 },
            glass: { cm_mult: 1.1, cs_mult: 0.9, base_efficiency_impact: 2 }, // Slightly better efficiency due to lower Cs
            composite: { cm_mult: 0.9, cs_mult: 0.8, base_efficiency_impact: 5 } // Best efficiency due to lower Cs
        };

        // --- Helper Functions ---

        // Shows a custom alert modal
        function showAlert(message) {
            customAlertMessage.textContent = message;
            customAlertModal.style.display = 'flex'; // Use flex to center
        }

        // Shows a custom confirm modal
        function showConfirm(message, onConfirmCallback) {
            customConfirmMessage.textContent = message;
            confirmYesBtn.onclick = () => {
                onConfirmCallback();
                customConfirmModal.style.display = 'none';
            };
            customConfirmModal.style.display = 'flex';
        }

        // Shows the loading overlay
        function showLoading() {
            ferrantiLoadingOverlay.classList.remove('hidden');
        }

        // Hides the loading overlay
        function hideLoading() {
            ferrantiLoadingOverlay.classList.add('hidden');
        }

        // --- Dark Mode ---
        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            if (document.body.classList.contains('dark')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
            // Re-render charts to apply theme colors if visible
            if (currentActiveTab === 'ferrantiEffect' && ferrantiSimStep === 5) {
                renderFerrantiVoltageProfileChart(currentFerrantiSimulationResults.voltageProfile, currentFerrantiSimulationResults.params.l);
            }
            if (currentActiveTab === 'insulatorSimulation' && insulatorSimStep === 1) {
                plotInsulatorVoltageDistribution();
            }
            if (currentActiveTab === 'analyticsDashboard') {
                updateAnalyticsDashboard();
            }
            if (currentActiveTab === 'comparisonView') {
                renderComparisonView();
            }
        }

        function applyDarkModeOnLoad() {
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark');
                darkModeToggle.checked = true;
            }
        }

        // --- Ferranti Effect Simulation Logic ---
        function validateFerrantiInputs(params) {
            for (const key in params) {
                if (typeof params[key] === 'number' && (isNaN(params[key]) || params[key] < 0)) {
                    showAlert(`Invalid input for ${key}. Please enter a valid positive number.`);
                    return false;
                }
            }
            if (params.f === 0) {
                showAlert("Frequency cannot be zero.");
                return false;
            }
            if (params.Vs_mag_kV === 0) {
                showAlert("Sending End Voltage cannot be zero.");
                return false;
            }
            return true;
        }

        function resetFerrantiInputParameters() {
            lineLengthInput.value = ferrantiDefaultParams.lineLength;
            resistanceInput.value = ferrantiDefaultParams.resistance;
            inductanceInput.value = ferrantiDefaultParams.inductance;
            capacitanceInput.value = ferrantiDefaultParams.capacitance;
            frequencyInput.value = ferrantiDefaultParams.frequency;
            sendingVoltageInput.value = ferrantiDefaultParams.sendingVoltage;
            loadConditionSelect.value = ferrantiDefaultParams.loadCondition;
            shuntReactorXLInput.value = ferrantiDefaultParams.shuntReactorXL;
        }

        function advanceFerrantiSimStep(nextStep) {
            showLoading();
            setTimeout(() => {
                ferrantiSimStep = nextStep;
                updateFerrantiSimulationStepUI();
                hideLoading();
            }, 300);
        }

        function updateFerrantiSimulationStepUI() {
            ferrantiStepContents.forEach(el => el.classList.add('hidden-step-content'));

            switch (ferrantiSimStep) {
                case 0:
                    ferrantiStepTitleEl.textContent = "Welcome!";
                    ferrantiStepInstructionEl.textContent = "This guided simulation will help you understand the Ferranti Effect. Click 'Start Experiment' to begin.";
                    document.getElementById('ferrantiStepWelcomeContent').classList.remove('hidden-step-content');
                    break;
                case 1:
                    ferrantiStepTitleEl.textContent = "Step 1: Set Parameters";
                    ferrantiStepInstructionEl.textContent = "Input the characteristics of your transmission line and the operating conditions. The Ferranti effect is more noticeable on long lines with high capacitance.";
                    ferrantiStepParametersContent.classList.remove('hidden-step-content');
                    break;
                case 2:
                    ferrantiStepTitleEl.textContent = "Step 2: Review Entered Data";
                    ferrantiStepInstructionEl.textContent = "Please verify the parameters you've entered. These values will be used for the simulation.";
                    displayFerrantiEnteredData();
                    ferrantiStepReviewDataContent.classList.remove('hidden-step-content');
                    break;
                case 3:
                    ferrantiStepTitleEl.textContent = "Step 3: Theoretical Background";
                    ferrantiStepInstructionEl.textContent = "Learn about the Ferranti Effect, the Nominal Pi Model, and ABCD parameters. This knowledge will help you predict the simulation results.";
                    ferrantiStepTheoryContent.classList.remove('hidden-step-content');
                    break;
                case 4:
                    ferrantiStepTitleEl.textContent = "Step 4: Your Turn to Calculate!";
                    ferrantiStepInstructionEl.textContent = "Based on the parameters and theory, try to estimate the Receiving End Voltage (Vr) and the Voltage Rise percentage. Enter your estimates below.";
                    setupFerrantiUserCalculation();
                    ferrantiStepUserCalculationContent.classList.remove('hidden-step-content');
                    break;
                case 5:
                    ferrantiStepTitleEl.textContent = "Step 5: Simulation & Results";
                    ferrantiStepInstructionEl.textContent = "The simulation has run! Analyze the numerical results and the voltage profile graph. Pay attention to the voltage at the receiving end.";
                    performFerrantiSimulationAndDisplayResults();
                    ferrantiStepResultsContent.classList.remove('hidden-step-content');
                    break;
                case 6:
                    ferrantiStepTitleEl.textContent = "Step 6: Analysis & Experimentation";
                    ferrantiStepInstructionEl.textContent = "Reflect on your results. How do the parameters influence the Ferranti effect? Consider running new experiments with different values or adding a shunt reactor.";
                    ferrantiStepAnalysisContent.classList.remove('hidden-step-content');
                    break;
            }
        }

        function resetFerrantiSimulationFlow() {
            showConfirm("Are you sure you want to reset the entire Ferranti Effect simulation flow? All current inputs will be cleared.", () => {
                ferrantiSimStep = 0;
                resetFerrantiInputParameters();
                ferrantiUserCalculatedVr = null;
                ferrantiUserCalculatedRise = null;
                currentFerrantiSimulationResults = null;
                ferrantiUserCalculationFeedback.textContent = '';
                ferrantiUserCalcToSimulateBtn.classList.add('hidden-step-content');
                updateFerrantiSimulationStepUI();
                Plotly.purge(voltageProfileChartDiv);
            });
        }

        function displayFerrantiEnteredData() {
            const params = {
                l: parseFloat(lineLengthInput.value),
                R_per_km: parseFloat(resistanceInput.value),
                L_per_km: parseFloat(inductanceInput.value),
                C_per_km: parseFloat(capacitanceInput.value),
                f: parseFloat(frequencyInput.value),
                Vs_mag_kV: parseFloat(sendingVoltageInput.value),
                loadCondition: loadConditionSelect.value,
                shuntReactorXL: parseFloat(shuntReactorXLInput.value)
            };

            ferrantiEnteredDataDisplay.innerHTML = `
                <p><strong>Line Length:</strong> ${params.l} km</p>
                <p><strong>Resistance:</strong> ${params.R_per_km} Œ©/km</p>
                <p><strong>Inductance:</strong> ${params.L_per_km} mH/km</p>
                <p><strong>Capacitance:</strong> ${params.C_per_km} nF/km</p>
                <p><strong>Frequency:</strong> ${params.f} Hz</p>
                <p><strong>Sending End Voltage:</strong> ${params.Vs_mag_kV} kV</p>
                <p><strong>Load Condition:</strong> ${params.loadCondition === 'noLoad' ? 'No Load (Open Circuit)' : 'Light Load (High Resistance)'}</p>
                <p><strong>Shunt Reactor XL:</strong> ${params.shuntReactorXL} Œ©</p>
            `;
        }

        function setupFerrantiUserCalculation() {
            userVrInput.value = '';
            userVoltageRiseInput.value = '';
            ferrantiUserCalculationFeedback.textContent = '';
            ferrantiUserCalcToSimulateBtn.classList.add('hidden-step-content');
            ferrantiUserCalculatedVr = null;
            ferrantiUserCalculatedRise = null;
        }

        function checkFerrantiUserCalculation() {
            const userVr = parseFloat(userVrInput.value);
            const userRise = parseFloat(userVoltageRiseInput.value);

            if (isNaN(userVr) || isNaN(userRise)) {
                ferrantiUserCalculationFeedback.textContent = "Please enter valid numbers for both fields.";
                ferrantiUserCalculationFeedback.className = 'user-calc-feedback incorrect';
                return;
            }

            const params = {
                l: parseFloat(lineLengthInput.value),
                R_per_km: parseFloat(resistanceInput.value),
                L_per_km: parseFloat(inductanceInput.value) / 1000, // H
                C_per_km: parseFloat(capacitanceInput.value) / 1e9, // F
                f: parseFloat(frequencyInput.value),
                Vs_mag_kV: parseFloat(sendingVoltageInput.value),
                loadCondition: loadConditionSelect.value,
                shuntReactorXL: parseFloat(shuntReactorXLInput.value)
            };

            if (!validateFerrantiInputs(params)) return;

            const simResults = calculateFerrantiEffect(params);
            const actualVr = simResults.Vr_mag_kV;
            const actualRise = simResults.voltageRise;

            const tolerance = 5;

            let isVrCorrect = Math.abs(userVr - actualVr) <= (actualVr * tolerance / 100);
            let isRiseCorrect = Math.abs(userRise - actualRise) <= (actualRise * tolerance / 100);

            if (isVrCorrect && isRiseCorrect) {
                ferrantiUserCalculationFeedback.textContent = `Excellent! Both your estimates are correct within ${tolerance}% tolerance.`;
                ferrantiUserCalculationFeedback.className = 'user-calc-feedback correct';
                ferrantiUserCalcToSimulateBtn.classList.remove('hidden-step-content');
                ferrantiUserCalculatedVr = userVr;
                ferrantiUserCalculatedRise = userRise;
            } else {
                let feedbackText = "Your estimates need adjustment. ";
                if (!isVrCorrect) {
                    feedbackText += `\nReceiving End Voltage (Vr): Your estimate (${userVr.toFixed(2)} kV) is off. Actual: ${actualVr.toFixed(2)} kV.`;
                }
                if (!isRiseCorrect) {
                    feedbackText += `\nVoltage Rise (%): Your estimate (${userRise.toFixed(2)} %) is off. Actual: ${actualRise.toFixed(2)} %.`;
                }
                ferrantiUserCalculationFeedback.textContent = feedbackText;
                ferrantiUserCalculationFeedback.className = 'user-calc-feedback incorrect';
                ferrantiUserCalcToSimulateBtn.classList.add('hidden-step-content');
                ferrantiUserCalculatedVr = null;
                ferrantiUserCalculatedRise = null;
            }
        }

        function calculateFerrantiEffect(params) {
            const Vs_mag = params.Vs_mag_kV * 1000;
            const omega = 2 * Math.PI * params.f;

            const R_total = params.R_per_km * params.l;
            const L_total = params.L_per_km * params.l;
            const C_total = params.C_per_km * params.l;

            const Z_line = new Complex(R_total, omega * L_total);
            const Y_line = new Complex(0, omega * C_total);

            const ZY_div_2 = Z_line.multiply(Y_line).divide(new Complex(2, 0));
            const A = new Complex(1, 0).add(ZY_div_2);
            const B = Z_line;
            const C = Y_line.multiply(new Complex(1, 0).add(ZY_div_2.divide(new Complex(2, 0))));
            const D = A;

            let Vr_complex, Ir_complex, Is_complex;
            let Y_reactor = new Complex(0, 0);

            if (params.shuntReactorXL > 0) {
                Y_reactor = new Complex(0, -1 / params.shuntReactorXL);
            }

            const Vs_complex = new Complex(Vs_mag, 0);

            if (params.loadCondition === 'noLoad') {
                Vr_complex = Vs_complex.divide(A.add(B.multiply(Y_reactor)));
                Ir_complex = Vr_complex.multiply(Y_reactor);
                Is_complex = C.multiply(Vr_complex).add(D.multiply(Ir_complex));
            } else if (params.loadCondition === 'lightLoad') {
                const R_load_light = 1e6;
                const Y_load_light = new Complex(1 / R_load_light, 0);
                const Y_total_receiving_end = Y_load_light.add(Y_reactor);
                Vr_complex = Vs_complex.divide(A.add(B.multiply(Y_total_receiving_end)));
                Ir_complex = Vr_complex.multiply(Y_total_receiving_end);
                Is_complex = C.multiply(Vr_complex).add(D.multiply(Ir_complex));
            }

            const numSections = 10;
            const sectionLength = params.l / numSections;

            const R_sub_per_km = params.R_per_km;
            const L_sub_per_km = params.L_per_km;
            const C_sub_per_km = params.C_per_km;

            let voltageProfile = [];
            voltageProfile.push({ distance: 0, voltage: Vr_complex.magnitude() / 1000 });

            for (let i = 1; i <= numSections; i++) {
                const subLineLength = i * sectionLength;
                const R_sub = R_sub_per_km * subLineLength;
                const L_sub = L_sub_per_km * subLineLength;
                const C_sub = C_sub_per_km * subLineLength;

                const Z_sub = new Complex(R_sub, omega * L_sub);
                const Y_sub = new Complex(0, omega * C_sub);

                const ZY_sub_div_2 = Z_sub.multiply(Y_sub).divide(new Complex(2, 0));
                const A_sub = new Complex(1, 0).add(ZY_sub_div_2);
                const B_sub = Z_sub;

                const V_point_complex = A_sub.multiply(Vr_complex).add(B_sub.multiply(Ir_complex));
                voltageProfile.push({ distance: subLineLength, voltage: V_point_complex.magnitude() / 1000 });
            }

            voltageProfile[numSections].voltage = Vs_complex.magnitude() / 1000;

            const Vs_display = Vs_mag / 1000;
            const Vr_display = Vr_complex.magnitude() / 1000;
            const Is_display = Is_complex.magnitude();
            const Ir_display = Ir_complex.magnitude();

            const voltageRise = ((Vr_display - Vs_display) / Vs_display) * 100;

            return {
                Vs_mag_kV: Vs_display,
                Vr_mag_kV: Vr_display,
                voltageRise: voltageRise,
                Is_mag_A: Is_display,
                Ir_mag_A: Ir_display,
                voltageProfile: voltageProfile
            };
        }

        function performFerrantiSimulationAndDisplayResults() {
            const params = {
                l: parseFloat(lineLengthInput.value),
                R_per_km: parseFloat(resistanceInput.value),
                L_per_km: parseFloat(inductanceInput.value) / 1000,
                C_per_km: parseFloat(capacitanceInput.value) / 1e9,
                f: parseFloat(frequencyInput.value),
                Vs_mag_kV: parseFloat(sendingVoltageInput.value),
                loadCondition: loadConditionSelect.value,
                shuntReactorXL: parseFloat(shuntReactorXLInput.value)
            };

            if (!validateFerrantiInputs(params)) {
                hideLoading();
                return;
            }

            currentFerrantiSimulationResults = calculateFerrantiEffect(params);

            displayVs.textContent = currentFerrantiSimulationResults.Vs_mag_kV.toFixed(2);
            displayVr.textContent = currentFerrantiSimulationResults.Vr_mag_kV.toFixed(2);
            displayVoltageRise.textContent = currentFerrantiSimulationResults.voltageRise.toFixed(2);
            displayIs.textContent = currentFerrantiSimulationResults.Is_mag_A.toFixed(3);
            displayIr.textContent = currentFerrantiSimulationResults.Ir_mag_A.toFixed(3);
            displayShuntReactorXL.textContent = params.shuntReactorXL.toFixed(1);

            renderFerrantiVoltageProfileChart(currentFerrantiSimulationResults.voltageProfile, params.l);

            // Log experiment automatically after results
            logExperiment('ferranti', {
                l: parseFloat(lineLengthInput.value),
                R_per_km: parseFloat(resistanceInput.value),
                L_per_km: parseFloat(inductanceInput.value),
                C_per_km: parseFloat(capacitanceInput.value),
                f: parseFloat(frequencyInput.value),
                Vs_mag_kV: parseFloat(sendingVoltageInput.value),
                loadCondition: loadConditionSelect.value,
                shuntReactorXL: parseFloat(shuntReactorXLInput.value)
            }, {
                Vs_mag_kV: currentFerrantiSimulationResults.Vs_mag_kV,
                Vr_mag_kV: currentFerrantiSimulationResults.Vr_mag_kV,
                voltageRise: currentFerrantiSimulationResults.voltageRise,
                Is_mag_A: currentFerrantiSimulationResults.Is_mag_A,
                Ir_mag_A: currentFerrantiSimulationResults.Ir_mag_A,
                voltageProfile: currentFerrantiSimulationResults.voltageProfile
            }, ferrantiUserCalculatedVr, ferrantiUserCalculatedRise, "(Auto-logged Ferranti run)");
        }

        function renderFerrantiVoltageProfileChart(voltageProfile, lineLength) {
            const xData = voltageProfile.map(p => p.distance);
            const yData = voltageProfile.map(p => p.voltage);

            const isDark = document.body.classList.contains('dark');
            const plotData = [{
                x: xData,
                y: yData,
                mode: 'lines+markers',
                name: 'Voltage Profile',
                line: { color: isDark ? '#82e0aa' : '#2ecc71', width: 3 },
                marker: { size: 8, color: isDark ? '#4299e1' : '#3182ce' },
                hoverinfo: 'x+y'
            }];

            const plotLayout = {
                title: {
                    text: 'Voltage Profile Along Transmission Line',
                    font: { color: isDark ? '#e2e8f0' : '#1a202c' }
                },
                xaxis: {
                    title: 'Distance from Receiving End (km)',
                    range: [0, lineLength],
                    tickfont: { color: isDark ? '#e2e8f0' : '#1a202c' },
                    gridcolor: isDark ? '#4a5568' : '#e2e8f0',
                    linecolor: isDark ? '#4a5568' : '#e2e8f0',
                },
                yaxis: {
                    title: 'Voltage (kV)',
                    tickfont: { color: isDark ? '#e2e8f0' : '#1a202c' },
                    gridcolor: isDark ? '#4a5568' : '#e2e8f0',
                    linecolor: isDark ? '#4a5568' : '#e2e8f0',
                },
                paper_bgcolor: isDark ? '#2d3748' : '#ffffff',
                plot_bgcolor: isDark ? '#2d3748' : '#ffffff',
                margin: { t: 60, b: 40, l: 50, r: 20 },
                height: 384,
                responsive: true
            };

            Plotly.newPlot(voltageProfileChartDiv, plotData, plotLayout, { responsive: true });
        }


        // --- Insulator Simulation Logic ---
        function resetInsulatorInputParameters() {
            insulatorNumDiscsInput.value = insulatorDefaultParams.numDiscs;
            insulatorTotalVoltageInput.value = insulatorDefaultParams.totalVoltage;
            insulatorCsInput.value = insulatorDefaultParams.cs;
            insulatorCmInput.value = insulatorDefaultParams.cm;
            insulatorMaterialSelect.value = insulatorDefaultParams.insulatorMaterial;
            pollutionLevelSelect.value = insulatorDefaultParams.pollutionLevel;
            humidityInput.value = insulatorDefaultParams.humidity;
            modalFaultVoltageInput.value = insulatorDefaultParams.faultVoltage;
            modalFaultDurationInput.value = insulatorDefaultParams.faultDuration;
            modalFaultyDiscIndexInput.value = insulatorDefaultParams.faultyDiscIndex;
            discPuncturedStatus = {}; // Clear punctured status
            isVoltageFlowAnimationEnabled = false; // Reset animation state
            toggleVoltageFlowBtn.textContent = '‚ö° Toggle Voltage Flow'; // Reset button text
            clearFaultVisual(); // Clear any active fault visual
            designModeContent.classList.add('hidden'); // Hide design mode
            toggleDesignModeBtn.textContent = '‚öôÔ∏è Design Mode'; // Reset button text
            designModeResult.textContent = ''; // Clear design mode result
        }

        function calculateInsulatorVoltageDistribution() {
            const n = parseInt(insulatorNumDiscsInput.value);
            const V_total = parseFloat(insulatorTotalVoltageInput.value);
            const Cs = parseFloat(insulatorCsInput.value);
            const Cm = parseFloat(insulatorCmInput.value);
            const insulatorMaterial = insulatorMaterialSelect.value;
            const pollutionLevel = pollutionLevelSelect.value;
            const humidity = parseFloat(humidityInput.value);
            const faultVoltage = parseFloat(modalFaultVoltageInput.value);
            const faultDuration = parseFloat(modalFaultDurationInput.value);
            const faultyDiscIndex = parseInt(modalFaultyDiscIndexInput.value);

            if (isNaN(n) || n <= 0 || isNaN(V_total) || V_total <= 0 || isNaN(Cs) || Cs < 0 || isNaN(Cm) || Cm <= 0) {
                showAlert("Please enter valid positive values for all insulator parameters.");
                insulatorCalculatedVoltages = [];
                insulatorCalculatedEfficiency = 0;
                renderInsulatorString();
                plotInsulatorVoltageDistribution();
                insulatorEfficiencyDisplay.textContent = `String Efficiency: N/A`;
                return;
            }

            insulatorCalculatedVoltages = calculateInsulatorDiscVoltages(n, V_total, Cs, Cm, discPuncturedStatus);
            insulatorCalculatedEfficiency = calculateInsulatorStringEfficiency(
                insulatorCalculatedVoltages, V_total, n,
                pollutionLevel, humidity, insulatorMaterial, discPuncturedStatus
            );

            renderInsulatorString();
            plotInsulatorVoltageDistribution();
            insulatorEfficiencyDisplay.textContent = `String Efficiency: ${insulatorCalculatedEfficiency.toFixed(2)}%`;

            // Apply fault visualization if applicable
            if (faultVoltage > 0 && faultDuration > 0 && faultyDiscIndex > 0 && faultyDiscIndex <= n) {
                applyFaultVisual(faultyDiscIndex, faultDuration);
            } else {
                clearFaultVisual();
            }

            // Log experiment automatically after results
            logExperiment('insulator', {
                n: n, V: V_total, Cs: Cs, Cm: Cm, insulatorMaterial: insulatorMaterial,
                pollutionLevel: pollutionLevel, humidity: humidity,
                faultVoltage: faultVoltage, faultDuration: faultDuration, faultyDiscIndex: faultyDiscIndex
            }, {
                voltages: insulatorCalculatedVoltages.map(v => parseFloat(v.toFixed(2))),
                efficiency: insulatorCalculatedEfficiency,
                maxDiscVoltage: insulatorCalculatedVoltages.length > 0 ? parseFloat(Math.max(...insulatorCalculatedVoltages).toFixed(2)) : 0,
                discPuncturedStatus: JSON.parse(JSON.stringify(discPuncturedStatus))
            }, null, null, "(Auto-logged Insulator run)");
        }

        function calculateInsulatorDiscVoltages(n, V_total, Cs, Cm, puncturedStatus = {}) {
            const activeDiscs = [];
            for (let i = 1; i <= n; i++) {
                if (!puncturedStatus[i]) {
                    activeDiscs.push(i);
                }
            }

            if (activeDiscs.length === 0) return Array(n).fill(0);

            const k = Cm !== 0 ? Cs / Cm : Infinity;
            let voltages = Array(n).fill(0);

            let denominator = 0;
            for (let j = 0; j < activeDiscs.length; j++) {
                denominator += Math.pow(1 + k, j);
            }

            if (V_total === 0 || denominator === 0) {
                return voltages;
            }

            let activeDiscVoltages = [];
            for (let i = 0; i < activeDiscs.length; i++) {
                const V_i_active = V_total * (Math.pow(1 + k, activeDiscs.length - 1 - i) / denominator);
                activeDiscVoltages.push(V_i_active);
            }

            let activeDiscCounter = 0;
            for (let i = 0; i < n; i++) {
                const currentDiscIndex = i + 1;
                if (!puncturedStatus[currentDiscIndex]) {
                    voltages[i] = activeDiscVoltages[activeDiscCounter];
                    activeDiscCounter++;
                } else {
                    voltages[i] = 0;
                }
            }
            return voltages;
        }

        function calculateInsulatorStringEfficiency(voltages_line_to_tower, V_total, n, pollutionLevel, humidity, material, puncturedStatus = {}) {
            if (!voltages_line_to_tower || voltages_line_to_tower.length === 0 || n === 0) return 0;

            const healthyVoltages = [];
            for (let i = 0; i < n; i++) {
                const discIndex = i + 1;
                if (!puncturedStatus[discIndex]) {
                    healthyVoltages.push(voltages_line_to_tower[i]);
                }
            }

            if (healthyVoltages.length === 0) return 0;

            const V_disc_max = healthyVoltages[0];
            if (V_disc_max === 0) return (V_total === 0 && n > 0) ? 100 : 0;

            let efficiency = (V_total / (n * V_disc_max)) * 100;

            let efficiencyReduction = 0;
            if (pollutionLevel === 'light') efficiencyReduction += 1;
            else if (pollutionLevel === 'medium') efficiencyReduction += 3;
            else if (pollutionLevel === 'heavy') efficiencyReduction += 7;

            if (humidity > 70) efficiencyReduction += (humidity - 70) * 0.1;

            const materialEffect = materialProperties[material] ? materialProperties[material].base_efficiency_impact : 0;
            efficiency += materialEffect;

            efficiency = Math.max(0, efficiency - efficiencyReduction);
            efficiency = Math.min(100, efficiency);

            return parseFloat(efficiency.toFixed(2));
        }

        function renderInsulatorString() {
            insulatorStringDiv.innerHTML = '';
            currentRunDataTableBody.innerHTML = '';

            const n = parseInt(insulatorNumDiscsInput.value);
            const V = parseFloat(insulatorTotalVoltageInput.value);
            
            const displayVoltages = [...insulatorCalculatedVoltages];

            const healthyVoltagesForMax = insulatorCalculatedVoltages.filter((v, idx) => !discPuncturedStatus[idx + 1]);
            const maxHealthyVoltage = healthyVoltagesForMax.length > 0 ? Math.max(...healthyVoltagesForMax) : 1;
            const baseAnimationDuration = 2;

            for (let i = n - 1; i >= 0; i--) {
                const disc = document.createElement('div');
                disc.className = 'disc';
                const currentDiscNumberFromLineEnd = i + 1;
                
                disc.setAttribute('data-disc-index', currentDiscNumberFromLineEnd);
                disc.addEventListener('click', openDiscPropertiesModal);

                const faultVoltage = parseFloat(modalFaultVoltageInput.value);
                const faultDuration = parseFloat(modalFaultDurationInput.value);
                const faultyDiscIndex = parseInt(modalFaultyDiscIndexInput.value);

                if (faultyDiscIndex === currentDiscNumberFromLineEnd && faultVoltage > 0) {
                    disc.classList.add('faulty');
                }
                if (discPuncturedStatus[currentDiscNumberFromLineEnd]) {
                    disc.classList.add('punctured');
                }

                const v_disc = displayVoltages[i];
                
                const normalizedVoltage = (v_disc / V) * 1.5;
                const hue = 240 - (normalizedVoltage * 120);
                const saturation = 100;
                const lightness = 40 + (normalizedVoltage * 30);

                if (!disc.classList.contains('punctured') && !disc.classList.contains('faulty')) {
                    disc.style.backgroundColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                    disc.style.borderColor = `hsl(${hue}, ${saturation}%, ${lightness - 10}%)`;
                    disc.style.color = (lightness < 50) ? 'white' : '#333';
                }

                if (isVoltageFlowAnimationEnabled && !disc.classList.contains('faulty') && !disc.classList.contains('punctured')) {
                    disc.classList.add('voltage-flow-active');
                    const animationDuration = (v_disc > 0 && maxHealthyVoltage > 0) ? 
                                               (baseAnimationDuration * (maxHealthyVoltage / v_disc)) : 
                                               (baseAnimationDuration * 2);
                    disc.style.animationDuration = `${animationDuration}s`;
                } else {
                    disc.classList.remove('voltage-flow-active');
                    disc.style.animationDuration = '';
                }

                disc.innerHTML = `${v_disc.toFixed(1)}<br><span class="unit">kV</span>`;
                disc.title = `Disc ${currentDiscNumberFromLineEnd} (from line)\nVoltage: ${v_disc.toFixed(2)} kV\n${((v_disc / V) * 100).toFixed(1)}% of total`;
                insulatorStringDiv.appendChild(disc);

                if (i > 0) {
                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svg.setAttribute("class", "connector-svg");
                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    path.setAttribute("d", "M0 45 C 10 35, 10 55, 20 45");
                    path.setAttribute("class", "connector-path");
                    svg.appendChild(path);
                    insulatorStringDiv.appendChild(svg);
                }

                const row = currentRunDataTableBody.insertRow(0);
                row.insertCell().textContent = currentDiscNumberFromLineEnd;
                row.insertCell().textContent = v_disc.toFixed(2);
                row.insertCell().textContent = discPuncturedStatus[currentDiscNumberFromLineEnd] ? 'Punctured' : 'Healthy';
            }
        }

        function plotInsulatorVoltageDistribution() {
            const labels = Array.from({ length: insulatorCalculatedVoltages.length }, (_, i) => `Disc ${i + 1}`);
            const data = [{
                x: labels,
                y: insulatorCalculatedVoltages,
                type: 'bar',
                name: `Voltage (kV) for Insulator String`,
                marker: { color: document.body.classList.contains('dark') ? '#66b2ff' : '#3498db' }
            }];
            const layout = {
                title: {
                    text: `Voltage Distribution Across Insulator String`,
                    font: { color: document.body.classList.contains('dark') ? '#e2e8f0' : '#1a202c' }
                },
                xaxis: {
                    title: 'Disc Number (from Line End)',
                    tickfont: { color: document.body.classList.contains('dark') ? '#e2e8f0' : '#1a202c' },
                    gridcolor: document.body.classList.contains('dark') ? '#4a5568' : '#e2e8f0',
                    linecolor: document.body.classList.contains('dark') ? '#4a5568' : '#e2e8f0',
                },
                yaxis: {
                    title: 'Voltage (kV)',
                    rangemode: 'tozero',
                    tickfont: { color: document.body.classList.contains('dark') ? '#e2e8f0' : '#1a202c' },
                    gridcolor: document.body.classList.contains('dark') ? '#4a5568' : '#e2e8f0',
                    linecolor: document.body.classList.contains('dark') ? '#4a5568' : '#e2e8f0',
                },
                height: 350,
                margin: { t: 40, b: 40, l: 40, r: 20 },
                plot_bgcolor: document.body.classList.contains('dark') ? '#2d3748' : '#ffffff',
                paper_bgcolor: document.body.classList.contains('dark') ? '#2d3748' : '#ffffff',
                responsive: true
            };
            Plotly.newPlot(insulatorVoltageChartDiv, data, layout, { responsive: true });
        }

        function applyFaultVisual(discIndex, duration) {
            clearFaultVisual();

            const discs = document.querySelectorAll('#insulator-string .disc');
            const targetDiscElement = discs[discs.length - discIndex];

            if (targetDiscElement) {
                targetDiscElement.classList.add('faulty');
                faultTimeoutId = setTimeout(() => {
                    clearFaultVisual();
                }, duration);
            }
        }

        function clearFaultVisual() {
            const faultyDiscs = document.querySelectorAll('#insulator-string .disc.faulty');
            faultyDiscs.forEach(disc => disc.classList.remove('faulty'));
            if (faultTimeoutId) {
                clearTimeout(faultTimeoutId);
                faultTimeoutId = null;
            }
        }

        function openDiscPropertiesModal(event) {
            const discElement = event.currentTarget;
            const discIndex = parseInt(discElement.getAttribute('data-disc-index'));
            currentEditedDiscIndex = discIndex;

            const n = parseInt(insulatorNumDiscsInput.value);
            const V = parseFloat(insulatorTotalVoltageInput.value);
            const Cs = parseFloat(insulatorCsInput.value);
            const Cm = parseFloat(insulatorCmInput.value);
            const voltages = calculateInsulatorDiscVoltages(n, V, Cs, Cm, discPuncturedStatus);
            const discVoltage = voltages[discIndex - 1];

            modalDiscIndexSpan.textContent = discIndex;
            modalDiscVoltageSpan.textContent = discVoltage.toFixed(2);
            isPuncturedCheckbox.checked = !!discPuncturedStatus[discIndex];

            discPropertiesModal.style.display = 'flex';
        }

        function saveDiscProperties() {
            if (currentEditedDiscIndex === null) return;

            const isPunctured = isPuncturedCheckbox.checked;
            
            if (isPunctured) {
                discPuncturedStatus[currentEditedDiscIndex] = true;
            } else {
                delete discPuncturedStatus[currentEditedDiscIndex];
            }

            discPropertiesModal.style.display = 'none';
            currentEditedDiscIndex = null;
            calculateInsulatorVoltageDistribution(); // Re-calculate and re-render
        }

        function toggleVoltageFlowAnimation() {
            isVoltageFlowAnimationEnabled = !isVoltageFlowAnimationEnabled;
            calculateInsulatorVoltageDistribution(); // Re-render to apply/remove animation
            toggleVoltageFlowBtn.textContent = isVoltageFlowAnimationEnabled ? '‚ö° Hide Voltage Flow' : '‚ö° Toggle Voltage Flow';
        }

        function openFaultSettingsModal() {
            modalFaultVoltageInput.value = parseFloat(insulatorDefaultParams.faultVoltage);
            modalFaultDurationInput.value = parseFloat(insulatorDefaultParams.faultDuration);
            modalFaultyDiscIndexInput.value = parseInt(insulatorDefaultParams.faultyDiscIndex);
            
            modalFaultyDiscIndexInput.max = parseInt(insulatorNumDiscsInput.value);

            faultSettingsModal.style.display = 'flex';
        }

        function saveFaultSettings() {
            insulatorDefaultParams.faultVoltage = parseFloat(modalFaultVoltageInput.value);
            insulatorDefaultParams.faultDuration = parseFloat(modalFaultDurationInput.value);
            insulatorDefaultParams.faultyDiscIndex = parseInt(modalFaultyDiscIndexInput.value);

            faultSettingsModal.style.display = 'none';
            showAlert("Fault settings saved. These will apply to the next insulator experiment run.");
        }

        function toggleDesignMode() {
            designModeContent.classList.toggle('hidden');
            toggleDesignModeBtn.textContent = designModeContent.classList.contains('hidden') ? '‚öôÔ∏è Design Mode' : '‚öôÔ∏è Hide Design Mode';
            designModeResult.textContent = '';
        }

        function calculateRequiredDiscs() {
            const targetV = parseFloat(targetSystemVoltageInput.value);
            const maxVPerDisc = parseFloat(maxVoltagePerDiscInput.value);

            if (isNaN(targetV) || isNaN(maxVPerDisc) || targetV <= 0 || maxVPerDisc <= 0) {
                designModeResult.textContent = "Please enter valid positive numbers for target voltages.";
                designModeResult.style.color = '#e74c3c';
                return;
            }

            const requiredDiscs = Math.ceil(targetV / maxVPerDisc);
            designModeResult.textContent = `Suggested Minimum Discs: ${requiredDiscs} (for ~${maxVPerDisc.toFixed(1)} kV per disc)`;
            designModeResult.style.color = '#27ae60';
        }

        function updateCapacitanceBasedOnMaterial() {
            const selectedMaterial = insulatorMaterialSelect.value;
            const props = materialProperties[selectedMaterial];
            if (props) {
                insulatorCmInput.value = (insulatorDefaultParams.cm * props.cm_mult).toFixed(2);
                insulatorCsInput.value = (insulatorDefaultParams.cs * props.cs_mult).toFixed(2);
            }
        }

        // --- Unified History & Analytics ---
        function loadHistoryFromLocalStorage() {
            const storedHistory = localStorage.getItem('unifiedExperimentHistory');
            if (storedHistory) {
                experimentHistory = JSON.parse(storedHistory);
                const maxId = experimentHistory.reduce((max, entry) => Math.max(max, entry.id), 0);
                experimentIdCounter = maxId;
            }
        }

        function saveHistoryToLocalStorage() {
            localStorage.setItem('unifiedExperimentHistory', JSON.stringify(experimentHistory));
        }

        function logExperiment(type, params, results, userCalc1 = null, userCalc2 = null, note = "") {
            experimentIdCounter++;
            const newEntry = {
                id: experimentIdCounter,
                type: type,
                timestamp: new Date().toLocaleString(),
                params: params,
                results: results,
                userCalc1: userCalc1, // For Ferranti: userVr, For Insulator: userDisc1Voltage
                userCalc2: userCalc2, // For Ferranti: userVoltageRise, For Insulator: userEfficiency
                note: note
            };
            experimentHistory.push(newEntry);
            saveHistoryToLocalStorage();
            updateHistoryTable();
            updateAnalyticsDashboard();
            updatePersonalizedFeedback();
            // showAlert("Experiment saved successfully!"); // Only show if explicitly requested by user action
        }

        function saveCurrentConfigWithNote() {
            let note = historyNoteInput.value.trim();
            if (!note) {
                showAlert("Please enter a note before saving.");
                return;
            }

            if (currentActiveTab === 'ferrantiEffect' && currentFerrantiSimulationResults) {
                logExperiment('ferranti', {
                    l: parseFloat(lineLengthInput.value),
                    R_per_km: parseFloat(resistanceInput.value),
                    L_per_km: parseFloat(inductanceInput.value),
                    C_per_km: parseFloat(capacitanceInput.value),
                    f: parseFloat(frequencyInput.value),
                    Vs_mag_kV: parseFloat(sendingVoltageInput.value),
                    loadCondition: loadConditionSelect.value,
                    shuntReactorXL: parseFloat(shuntReactorXLInput.value)
                }, {
                    Vs_mag_kV: currentFerrantiSimulationResults.Vs_mag_kV,
                    Vr_mag_kV: currentFerrantiSimulationResults.Vr_mag_kV,
                    voltageRise: currentFerrantiSimulationResults.voltageRise,
                    Is_mag_A: currentFerrantiSimulationResults.Is_mag_A,
                    Ir_mag_A: currentFerrantiSimulationResults.Ir_mag_A,
                    voltageProfile: currentFerrantiSimulationResults.voltageProfile
                }, ferrantiUserCalculatedVr, ferrantiUserCalculatedRise, note);
            } else if (currentActiveTab === 'insulatorSimulation' && insulatorCalculatedVoltages.length > 0) {
                 logExperiment('insulator', {
                    n: parseInt(insulatorNumDiscsInput.value),
                    V: parseFloat(insulatorTotalVoltageInput.value),
                    Cs: parseFloat(insulatorCsInput.value),
                    Cm: parseFloat(insulatorCmInput.value),
                    insulatorMaterial: insulatorMaterialSelect.value,
                    pollutionLevel: pollutionLevelSelect.value,
                    humidity: parseFloat(humidityInput.value),
                    faultVoltage: parseFloat(modalFaultVoltageInput.value),
                    faultDuration: parseFloat(modalFaultDurationInput.value),
                    faultyDiscIndex: parseInt(modalFaultyDiscIndexInput.value)
                }, {
                    voltages: insulatorCalculatedVoltages.map(v => parseFloat(v.toFixed(2))),
                    efficiency: insulatorCalculatedEfficiency,
                    maxDiscVoltage: insulatorCalculatedVoltages.length > 0 ? parseFloat(Math.max(...insulatorCalculatedVoltages).toFixed(2)) : 0,
                    discPuncturedStatus: JSON.parse(JSON.stringify(discPuncturedStatus))
                }, null, null, note); // User calcs for insulator are not directly logged here
            } else {
                showAlert("No simulation results to save. Please run an experiment first.");
                return;
            }
            historyNoteInput.value = '';
            showAlert("Configuration saved successfully!");
        }


        function updateHistoryTable() {
            historyTableBody.innerHTML = '';
            experimentHistory.forEach(entry => {
                const row = historyTableBody.insertRow();
                row.insertCell().textContent = entry.id;
                row.insertCell().textContent = entry.type === 'ferranti' ? 'Ferranti' : 'Insulator';
                row.insertCell().textContent = entry.timestamp;

                // Dynamic columns based on type
                if (entry.type === 'ferranti') {
                    row.insertCell().textContent = entry.params.l; // Length
                    row.insertCell().textContent = entry.params.R_per_km; // R
                    row.insertCell().textContent = entry.params.L_per_km; // L
                    row.insertCell().textContent = entry.params.C_per_km; // C
                    row.insertCell().textContent = entry.params.f; // Freq
                    row.insertCell().textContent = entry.params.Vs_mag_kV; // Vs
                    row.insertCell().textContent = entry.params.loadCondition === 'noLoad' ? 'No Load' : 'Light Load'; // Load
                    row.insertCell().textContent = entry.params.shuntReactorXL; // Reactor XL
                    row.insertCell().textContent = entry.results.Vr_mag_kV.toFixed(2); // Vr
                    row.insertCell().textContent = entry.results.voltageRise.toFixed(2); // Rise
                    row.insertCell().textContent = entry.results.Is_mag_A.toFixed(3); // Is
                    row.insertCell().textContent = entry.results.Ir_mag_A.toFixed(3); // Ir
                    row.insertCell().textContent = entry.userCalc1 !== null ? entry.userCalc1.toFixed(2) : 'N/A'; // User Vr
                    row.insertCell().textContent = entry.userCalc2 !== null ? entry.userCalc2.toFixed(2) : 'N/A'; // User Rise
                    row.insertCell().textContent = 'N/A'; // Punctured Discs (not applicable)
                } else { // Insulator
                    row.insertCell().textContent = entry.params.n; // Discs
                    row.insertCell().textContent = entry.params.V; // V_total
                    row.insertCell().textContent = entry.params.Cs; // Cs
                    row.insertCell().textContent = entry.params.Cm; // Cm
                    const k = entry.params.Cm !== 0 ? (entry.params.Cs / entry.params.Cm).toFixed(3) : 'Infinity';
                    row.insertCell().textContent = k; // k
                    row.insertCell().textContent = entry.results.efficiency; // Efficiency
                    row.insertCell().textContent = entry.results.maxDiscVoltage; // MaxV
                    row.insertCell().textContent = entry.userCalc2 !== null ? entry.userCalc2.toFixed(2) : 'N/A'; // User Eff
                    row.insertCell().textContent = entry.userCalc1 !== null ? entry.userCalc1.toFixed(2) : 'N/A'; // User Disc1V
                    row.insertCell().textContent = entry.params.insulatorMaterial; // Material
                    row.insertCell().textContent = entry.params.pollutionLevel; // Pollution
                    row.insertCell().textContent = entry.params.humidity; // Humidity
                    row.insertCell().textContent = entry.params.faultVoltage; // FaultV
                    row.insertCell().textContent = entry.params.faultDuration; // FaultDur
                    const puncturedDiscs = Object.keys(entry.results.discPuncturedStatus || {}).filter(key => entry.results.discPuncturedStatus[key]).join(';');
                    row.insertCell().textContent = puncturedDiscs || 'None'; // Punctured Discs
                }
                
                row.insertCell().textContent = entry.note;

                const actionsCell = row.insertCell();
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.className = 'action-btn-delete px-2 py-1 rounded text-sm';
                deleteBtn.onclick = () => deleteHistoryEntry(entry.id);
                actionsCell.appendChild(deleteBtn);

                const compareCell = row.insertCell();
                const compareBtn = document.createElement('button');
                compareBtn.textContent = 'Compare';
                compareBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-sm';
                compareBtn.onclick = () => addForComparison(entry.id);
                compareCell.appendChild(compareBtn);
            });
            populateCompareRunsSelect(); // Update the select options whenever history changes
        }

        function deleteHistoryEntry(id) {
            showConfirm(`Are you sure you want to delete experiment ID ${id}? This cannot be undone.`, () => {
                experimentHistory = experimentHistory.filter(entry => entry.id !== id);
                comparisonExperiments = comparisonExperiments.filter(exp => exp.id !== id); // Also remove from comparison
                saveHistoryToLocalStorage();
                updateHistoryTable();
                updateAnalyticsDashboard();
                updatePersonalizedFeedback();
                renderComparisonView();
            });
        }

        function clearAllHistory() {
            showConfirm("Are you sure you want to clear ALL experiment history? This cannot be undone.", () => {
                experimentHistory = [];
                experimentIdCounter = 0;
                comparisonExperiments = [];
                saveHistoryToLocalStorage();
                updateHistoryTable();
                updateAnalyticsDashboard();
                updatePersonalizedFeedback();
                renderComparisonView();
                showAlert("All history cleared.");
            });
        }

        function exportHistoryToCSV() {
            if (experimentHistory.length === 0) {
                showAlert("No history to export.");
                return;
            }

            const headers = [
                "ID", "Type", "Timestamp",
                "Ferranti_Length_km", "Ferranti_R_Ohm_per_km", "Ferranti_L_mH_per_km", "Ferranti_C_nF_per_km",
                "Ferranti_Frequency_Hz", "Ferranti_Sending_Voltage_kV", "Ferranti_Load_Condition", "Ferranti_Shunt_Reactor_XL_Ohm",
                "Ferranti_Receiving_Voltage_kV", "Ferranti_Voltage_Rise_Percent", "Ferranti_Sending_Current_A", "Ferranti_Receiving_Current_A",
                "Ferranti_User_Estimated_Vr_kV", "Ferranti_User_Estimated_Rise_Percent", "Ferranti_Voltage_Profile_kV",
                "Insulator_Num_Discs", "Insulator_Total_Voltage_kV", "Insulator_Cs_nF", "Insulator_Cm_nF",
                "Insulator_Material", "Insulator_Pollution_Level", "Insulator_Humidity_Percent",
                "Insulator_Fault_Voltage_kV", "Insulator_Fault_Duration_ms", "Insulator_Faulty_Disc_Index",
                "Insulator_Efficiency_Percent", "Insulator_Max_Disc_Voltage_kV", "Insulator_Punctured_Discs",
                "Insulator_Voltages_Per_Disc_kV",
                "Note"
            ];

            const rows = experimentHistory.map(entry => {
                let rowData = Array(headers.length).fill(''); // Initialize with empty strings

                rowData[0] = entry.id;
                rowData[1] = entry.type;
                rowData[2] = `"${entry.timestamp}"`;

                if (entry.type === 'ferranti') {
                    rowData[3] = entry.params.l;
                    rowData[4] = entry.params.R_per_km;
                    rowData[5] = entry.params.L_per_km;
                    rowData[6] = entry.params.C_per_km;
                    rowData[7] = entry.params.f;
                    rowData[8] = entry.params.Vs_mag_kV;
                    rowData[9] = `"${entry.params.loadCondition}"`;
                    rowData[10] = entry.params.shuntReactorXL;
                    rowData[11] = entry.results.Vr_mag_kV.toFixed(2);
                    rowData[12] = entry.results.voltageRise.toFixed(2);
                    rowData[13] = entry.results.Is_mag_A.toFixed(3);
                    rowData[14] = entry.results.Ir_mag_A.toFixed(3);
                    rowData[15] = entry.userCalc1 !== null ? entry.userCalc1.toFixed(2) : 'N/A';
                    rowData[16] = entry.userCalc2 !== null ? entry.userCalc2.toFixed(2) : 'N/A';
                    const ferrantiProfileString = entry.results.voltageProfile.map(p => `${p.distance.toFixed(0)}km:${p.voltage.toFixed(2)}kV`).join(';');
                    rowData[17] = `"${ferrantiProfileString}"`;
                } else { // Insulator
                    rowData[18] = entry.params.n;
                    rowData[19] = entry.params.V;
                    rowData[20] = entry.params.Cs;
                    rowData[21] = entry.params.Cm;
                    rowData[22] = `"${entry.params.insulatorMaterial}"`;
                    rowData[23] = `"${entry.params.pollutionLevel}"`;
                    rowData[24] = entry.params.humidity;
                    rowData[25] = entry.params.faultVoltage;
                    rowData[26] = entry.params.faultDuration;
                    rowData[27] = entry.params.faultyDiscIndex;
                    rowData[28] = entry.results.efficiency;
                    rowData[29] = entry.results.maxDiscVoltage;
                    const puncturedDiscs = Object.keys(entry.results.discPuncturedStatus || {}).filter(key => entry.results.discPuncturedStatus[key]).join(';');
                    rowData[30] = `"${puncturedDiscs}"`;
                    rowData[31] = `"${entry.results.voltages.join(';')}"`;
                }
                rowData[32] = `"${entry.note.replace(/"/g, '""')}"`;

                return rowData.map(item => (typeof item === 'string' && item.includes(',')) ? `"${item}"` : item).join(',');
            });

            const csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "simulation_history.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function updateAnalyticsDashboard() {
            const isDark = document.body.classList.contains('dark');
            const commonLayoutProps = {
                paper_bgcolor: isDark ? '#2d3748' : '#ffffff',
                plot_bgcolor: isDark ? '#2d3748' : '#ffffff',
                font: { color: isDark ? '#e2e8f0' : '#1a202c' },
                xaxis: { gridcolor: isDark ? '#4a5568' : '#e2e8f0', linecolor: isDark ? '#4a5568' : '#e2e8f0' },
                yaxis: { gridcolor: isDark ? '#4a5568' : '#e2e8f0', linecolor: isDark ? '#4a5568' : '#e2e8f0' },
                margin: { t: 40, b: 40, l: 50, r: 20 },
                height: 320,
                responsive: true
            };

            const ferrantiExperiments = experimentHistory.filter(e => e.type === 'ferranti');
            const insulatorExperiments = experimentHistory.filter(e => e.type === 'insulator');

            // --- Ferranti Charts ---
            const dataVrVsLength = [{
                x: ferrantiExperiments.map(e => e.params.l),
                y: ferrantiExperiments.map(e => e.results.Vr_mag_kV),
                mode: 'markers', type: 'scatter',
                marker: { color: isDark ? '#82e0aa' : '#2ecc71', size: 8 }, name: 'Vr (kV)'
            }];
            Plotly.newPlot('chartVrVsLength', dataVrVsLength, {
                title: 'Ferranti: Receiving End Voltage vs. Line Length', xaxis: { title: 'Line Length (km)' },
                yaxis: { title: 'Receiving End Voltage (kV)' }, ...commonLayoutProps
            });

            const noLoadData = ferrantiExperiments.filter(e => e.params.loadCondition === 'noLoad');
            const lightLoadData = ferrantiExperiments.filter(e => e.params.loadCondition === 'lightLoad');
            const dataRiseVsLoad = [
                { x: noLoadData.map(e => `ID ${e.id}`), y: noLoadData.map(e => e.results.voltageRise),
                    type: 'bar', name: 'No Load', marker: { color: isDark ? '#4299e1' : '#3182ce' } },
                { x: lightLoadData.map(e => `ID ${e.id}`), y: lightLoadData.map(e => e.results.voltageRise),
                    type: 'bar', name: 'Light Load', marker: { color: isDark ? '#f6ad55' : '#dd6b20' } }
            ];
            Plotly.newPlot('chartRiseVsLoad', dataRiseVsLoad, {
                barmode: 'group', title: 'Ferranti: Voltage Rise vs. Load Condition',
                xaxis: { title: 'Experiment ID' }, yaxis: { title: 'Voltage Rise (%)' }, ...commonLayoutProps
            });

            const reactorExperiments = ferrantiExperiments.filter(e => e.params.shuntReactorXL > 0);
            const nonReactorExperiments = ferrantiExperiments.filter(e => e.params.shuntReactorXL === 0);
            const dataReactorEffect = [
                { x: nonReactorExperiments.map(e => `ID ${e.id}`), y: nonReactorExperiments.map(e => e.results.voltageRise),
                    type: 'bar', name: 'No Reactor', marker: { color: isDark ? '#e53e3e' : '#c53030' } },
                { x: reactorExperiments.map(e => `ID ${e.id} (XL=${e.params.shuntReactorXL}Œ©)`), y: reactorExperiments.map(e => e.results.voltageRise),
                    type: 'bar', name: 'With Reactor', marker: { color: isDark ? '#38b2ac' : '#319795' } }
            ];
            Plotly.newPlot('chartReactorEffect', dataReactorEffect, {
                barmode: 'group', title: 'Ferranti: Voltage Rise with/without Shunt Reactor',
                xaxis: { title: 'Experiment ID' }, yaxis: { title: 'Voltage Rise (%)' }, ...commonLayoutProps
            });

            const ferrantiUserVsSystemData = ferrantiExperiments.filter(e => e.userCalc2 !== null);
            const dataFerrantiUserVsSystem = [
                { x: ferrantiUserVsSystemData.map(e => `ID ${e.id}`), y: ferrantiUserVsSystemData.map(e => e.userCalc2),
                    type: 'bar', name: 'User Estimated Rise (%)', marker: { color: isDark ? '#9f7aea' : '#805ad5' } },
                { x: ferrantiUserVsSystemData.map(e => `ID ${e.id}`), y: ferrantiUserVsSystemData.map(e => e.results.voltageRise),
                    type: 'bar', name: 'System Calculated Rise (%)', marker: { color: isDark ? '#63b3ed' : '#3b82f6' } }
            ];
            Plotly.newPlot('chartUserVsSystemFerranti', dataFerrantiUserVsSystem, {
                barmode: 'group', title: 'Ferranti: User Estimated vs. System Calculated Voltage Rise',
                xaxis: { title: 'Experiment ID' }, yaxis: { title: 'Voltage Rise (%)' }, ...commonLayoutProps
            });

            // --- Insulator Charts ---
            const layoutEfficiencyVsK = {
                title: 'Insulator: String Efficiency vs. k (Cs/Cm)',
                xaxis: { title: 'k (Cs/Cm)' }, yaxis: { title: 'String Efficiency (%)', range: [0, 105] },
                ...commonLayoutProps
            };
            const dataEfficiencyVsK = [{
                x: insulatorExperiments.map(e => e.params.Cm !== 0 ? e.params.Cs / e.params.Cm : Infinity),
                y: insulatorExperiments.map(e => e.results.efficiency),
                text: insulatorExperiments.map(e => `ID:${e.id}`),
                hovertext: insulatorExperiments.map(e => `Run ${e.id}: ${e.note || 'No note'}<br>n=${e.params.n}, V=${e.params.V}, Cs=${e.params.Cs}, Cm=${e.params.Cm}`),
                mode: 'markers+text', type: 'scatter', textposition: 'top center',
                marker: { size: 10, color: insulatorExperiments.map(e => e.results.efficiency), colorscale: 'Viridis', showscale: true }
            }];
            Plotly.newPlot('efficiencyVsKGraph', dataEfficiencyVsK, layoutEfficiencyVsK, { responsive: true });

            const nValues = Array.from(new Set(insulatorExperiments.map(e => e.params.n))).sort((a, b) => a - b);
            let voltageTrendsData = [];
            const colorScale = [
                isDark ? '#88CCEE' : '#1f77b4', isDark ? '#CC6677' : '#ff7f0e', isDark ? '#DDCCEE' : '#2ca02c',
                isDark ? '#44AA99' : '#d62728', isDark ? '#999933' : '#9467bd'
            ];
            nValues.forEach((n, idx) => {
                const nFilteredHistory = insulatorExperiments.filter(e => e.params.n === n);
                if (nFilteredHistory.length > 0) {
                    voltageTrendsData.push({
                        x: nFilteredHistory.map(e => e.id), y: nFilteredHistory.map(e => e.results.maxDiscVoltage),
                        mode: 'lines+markers', name: `Max V for n=${n}`,
                        line: { color: colorScale[idx % colorScale.length] }, marker: { size: 8 }
                    });
                }
            });
            const layoutVoltageTrends = {
                title: 'Insulator: Maximum Disc Voltage Trends Across Experiments',
                xaxis: { title: 'Experiment Run ID' }, yaxis: { title: 'Max Disc Voltage (kV)' }, ...commonLayoutProps
            };
            Plotly.newPlot('voltageTrendsGraph', voltageTrendsData, layoutVoltageTrends, { responsive: true });

            const efficiencyOverTimeData = [{
                x: insulatorExperiments.map(e => e.id), y: insulatorExperiments.map(e => e.results.efficiency),
                text: insulatorExperiments.map(e => `Eff:${e.results.efficiency}%`),
                hovertext: insulatorExperiments.map(e => `Run ${e.id}: Eff ${e.results.efficiency}%<br>k=${e.params.Cm !== 0 ? (e.params.Cs / e.params.Cm).toFixed(3) : 'Infinity'}, n=${e.params.n}`),
                mode: 'lines+markers', type: 'scatter', marker: { size: 8 }
            }];
            const layoutEfficiencyOverTime = {
                title: 'Insulator: String Efficiency Over Experiments',
                xaxis: { title: 'Experiment Run ID' }, yaxis: { title: 'String Efficiency (%)', range: [0, 105] },
                ...commonLayoutProps
            };
            Plotly.newPlot('efficiencyOverTimeGraph', efficiencyOverTimeData, layoutEfficiencyOverTime, { responsive: true });

            const experimentsWithUserEff = insulatorExperiments.filter(e => e.userCalc2 !== null);
            const labelsUserEff = experimentsWithUserEff.map(e => `Run ${e.id}`);
            const userEfficiencies = experimentsWithUserEff.map(e => e.userCalc2);
            const systemEfficiencies = experimentsWithUserEff.map(e => e.results.efficiency);
            const dataUserVsSystemEfficiency = [
                { x: labelsUserEff, y: userEfficiencies, type: 'bar', name: 'User Calculated Efficiency (%)',
                    marker: { color: isDark ? '#4CAF50' : '#8BC34A' } },
                { x: labelsUserEff, y: systemEfficiencies, type: 'bar', name: 'System Calculated Efficiency (%)',
                    marker: { color: isDark ? '#2196F3' : '#03A9F4' } }
            ];
            const layoutUserVsSystemEfficiency = {
                barmode: 'group', title: 'Insulator: User vs. System Calculated String Efficiency',
                xaxis: { title: 'Experiment Run', automargin: true }, yaxis: { title: 'Efficiency (%)', range: [0, 105] }, ...commonLayoutProps
            };
            Plotly.newPlot('userVsSystemEfficiencyGraph', dataUserVsSystemEfficiency, layoutUserVsSystemEfficiency, { responsive: true });

            const experimentsWithUserDisc1V = insulatorExperiments.filter(e => e.userCalc1 !== null);
            const labelsUserDisc1V = experimentsWithUserDisc1V.map(e => `Run ${e.id}`);
            const userDisc1Voltages = experimentsWithUserDisc1V.map(e => e.userCalc1);
            const systemDisc1Voltages = experimentsWithUserDisc1V.map(e => e.results.voltages[0]);
            const dataUserVsSystemDisc1Voltage = [
                { x: labelsUserDisc1V, y: userDisc1Voltages, type: 'bar', name: 'User Calculated Disc 1 Voltage (kV)',
                    marker: { color: isDark ? '#FFC107' : '#FFEB3B' } },
                { x: labelsUserDisc1V, y: systemDisc1Voltages, type: 'bar', name: 'System Calculated Disc 1 Voltage (kV)',
                    marker: { color: isDark ? '#FF5722' : '#FF9800' } }
            ];
            const layoutUserVsSystemDisc1Voltage = {
                barmode: 'group', title: 'Insulator: User vs. System Calculated Disc 1 Voltage',
                xaxis: { title: 'Experiment Run', automargin: true }, yaxis: { title: 'Voltage (kV)', rangemode: 'tozero' }, ...commonLayoutProps
            };
            Plotly.newPlot('userVsSystemDisc1VoltageGraph', dataUserVsSystemDisc1Voltage, layoutUserVsSystemDisc1Voltage, { responsive: true });
        }

        function updatePersonalizedFeedback() {
            if (experimentHistory.length < 3) {
                personalizedFeedbackEl.textContent = "Complete at least 3 experiments for personalized feedback.";
                return;
            }

            const lastThreeRuns = experimentHistory.slice(-3);
            let feedback = "Recent Trends:\n";

            // Analyze Ferranti-specific trends
            const ferrantiRuns = lastThreeRuns.filter(e => e.type === 'ferranti');
            if (ferrantiRuns.length > 0) {
                const rises = ferrantiRuns.map(e => e.results.voltageRise);
                if (rises.length >= 2 && rises[0] < rises[1]) {
                    feedback += "  - Ferranti: Voltage rise is increasing in recent runs. Consider line length or load changes.\n";
                } else if (rises.length >= 2 && rises[0] > rises[1]) {
                    feedback += "  - Ferranti: Voltage rise is decreasing. Good if you're mitigating the effect!\n";
                }
            }

            // Analyze Insulator-specific trends
            const insulatorRuns = lastThreeRuns.filter(e => e.type === 'insulator');
            if (insulatorRuns.length > 0) {
                const efficiencies = insulatorRuns.map(e => e.results.efficiency);
                if (efficiencies.length >= 2 && efficiencies[0] < efficiencies[1]) {
                    feedback += "  - Insulator: String efficiency is improving! Keep optimizing.\n";
                } else if (efficiencies.length >= 2 && efficiencies[0] > efficiencies[1]) {
                    feedback += "  - Insulator: String efficiency is decreasing. Check k-value or environmental factors.\n";
                }
                const kValues = insulatorRuns.map(e => e.params.Cm !== 0 ? e.params.Cs / e.params.Cm : Infinity);
                if (kValues.some(k => k > 1.5)) {
                    feedback += "  - Insulator: High k-values (Cs/Cm) can lead to lower efficiency. Experiment with different materials.\n";
                }
            }

            personalizedFeedbackEl.textContent = (feedback === "Recent Trends:\n") ? "No strong simple trends detected in the last 3 experiments." : feedback;
        }

        // --- Comparison View ---
        function addForComparison(id) {
            const entry = experimentHistory.find(e => e.id === id);
            if (!entry) return;

            if (comparisonExperiments.length >= 2) {
                showAlert("You can compare a maximum of 2 experiments. Please remove one to add another.");
                return;
            }
            if (comparisonExperiments.some(exp => exp.id === id)) {
                showAlert("This experiment is already selected for comparison.");
                return;
            }
            comparisonExperiments.push(entry); // Push the entire entry object
            renderComparisonView();
            openTab(null, 'comparisonView');
        }

        function removeComparisonItem(id) {
            comparisonExperiments = comparisonExperiments.filter(exp => exp.id !== id);
            renderComparisonView();
        }

        function renderComparisonView() {
            comparisonContainer.innerHTML = '';

            if (comparisonExperiments.length === 0) {
                comparisonContainer.innerHTML = '<p class="text-center text-gray-600 dark:text-gray-400 col-span-full">No experiments selected for comparison. Add some from the History tab!</p>';
                return;
            }

            comparisonExperiments.forEach(exp => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'comparison-item p-4 rounded-lg shadow-md';
                
                let contentHtml = `<h3 class="text-xl font-bold text-blue-600 dark:text-blue-400 mb-2">Experiment ID: ${exp.id} (${exp.type === 'ferranti' ? 'Ferranti' : 'Insulator'})</h3>
                                   <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">${exp.timestamp}</p><div class="grid grid-cols-2 gap-2 text-sm mb-4">`;

                if (exp.type === 'ferranti') {
                    contentHtml += `
                        <p><strong>Length:</strong> ${exp.params.l} km</p>
                        <p><strong>R:</strong> ${exp.params.R_per_km} Œ©/km</p>
                        <p><strong>L:</strong> ${exp.params.L_per_km} mH/km</p>
                        <p><strong>C:</strong> ${exp.params.C_per_km} nF/km</p>
                        <p><strong>Freq:</strong> ${exp.params.f} Hz</p>
                        <p><strong>Vs:</strong> ${exp.params.Vs_mag_kV} kV</p>
                        <p class="col-span-2"><strong>Load:</strong> ${exp.params.loadCondition === 'noLoad' ? 'No Load' : 'Light Load'}</p>
                        <p class="col-span-2"><strong>Reactor XL:</strong> ${exp.params.shuntReactorXL} Œ©</p>
                        </div><hr class="my-4 border-gray-200 dark:border-gray-600">
                        <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Results:</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm mb-4">
                        <p><strong>Vr:</strong> ${exp.results.Vr_mag_kV.toFixed(2)} kV</p>
                        <p><strong>Rise:</strong> ${exp.results.voltageRise.toFixed(2)} %</p>
                        <p><strong>Is:</strong> ${exp.results.Is_mag_A.toFixed(3)} A</p>
                        <p><strong>Ir:</strong> ${exp.results.Ir_mag_A.toFixed(3)} A</p>
                        ${exp.userCalc1 !== null ? `<p><strong>User Vr:</strong> ${exp.userCalc1.toFixed(2)} kV</p>` : ''}
                        ${exp.userCalc2 !== null ? `<p><strong>User Rise:</strong> ${exp.userCalc2.toFixed(2)} %</p>` : ''}
                        </div>
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-4"><strong>Note:</strong> ${exp.note || 'No note'}</p>
                        <div id="compChart-${exp.id}" class="w-full h-64 bg-gray-50 dark:bg-gray-800 rounded-md shadow-inner"></div>
                    `;
                } else { // Insulator
                    const k = exp.params.Cm !== 0 ? (exp.params.Cs / exp.params.Cm).toFixed(3) : 'Infinity';
                    const puncturedDiscs = Object.keys(exp.results.discPuncturedStatus || {}).filter(key => exp.results.discPuncturedStatus[key]).join(';');
                    contentHtml += `
                        <p><strong>Discs (n):</strong> ${exp.params.n}</p>
                        <p><strong>Total V:</strong> ${exp.params.V} kV</p>
                        <p><strong>Cs:</strong> ${exp.params.Cs} nF</p>
                        <p><strong>Cm:</strong> ${exp.params.Cm} nF</p>
                        <p><strong>k:</strong> ${k}</p>
                        <p><strong>Material:</strong> ${exp.params.insulatorMaterial}</p>
                        <p><strong>Pollution:</strong> ${exp.params.pollutionLevel}</p>
                        <p><strong>Humidity:</strong> ${exp.params.humidity}%</p>
                        <p><strong>Fault V:</strong> ${exp.params.faultVoltage} kV</p>
                        <p><strong>Fault Dur:</strong> ${exp.params.faultDuration} ms</p>
                        <p><strong>Faulty Disc:</strong> ${exp.params.faultyDiscIndex}</p>
                        </div><hr class="my-4 border-gray-200 dark:border-gray-600">
                        <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Results:</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm mb-4">
                        <p><strong>Efficiency:</strong> ${exp.results.efficiency.toFixed(2)} %</p>
                        <p><strong>Max Disc V:</strong> ${exp.results.maxDiscVoltage.toFixed(2)} kV</p>
                        ${exp.userCalc2 !== null ? `<p><strong>User Eff:</strong> ${exp.userCalc2.toFixed(2)} %</p>` : ''}
                        ${exp.userCalc1 !== null ? `<p><strong>User Disc1 V:</strong> ${exp.userCalc1.toFixed(2)} kV</p>` : ''}
                        <p class="col-span-2"><strong>Punctured:</strong> ${puncturedDiscs || 'None'}</p>
                        </div>
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-4"><strong>Note:</strong> ${exp.note || 'No note'}</p>
                        <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Voltage Distribution:</h4>
                        <div id="comparisonDiscString-${exp.id}" class="comparison-disc-string"></div>
                        <div id="compChart-${exp.id}" class="w-full h-64 bg-gray-50 dark:bg-gray-800 rounded-md shadow-inner"></div>
                    `;
                }
                itemDiv.innerHTML += `<button onclick="removeComparisonItem(${exp.id})" class="action-btn-delete mt-4 px-3 py-1 rounded text-sm">Remove from Comparison</button>`;
                comparisonContainer.appendChild(itemDiv);

                // Render specific charts based on type
                if (exp.type === 'ferranti') {
                    const chartDivId = `compChart-${exp.id}`;
                    const xData = exp.results.voltageProfile.map(p => p.distance);
                    const yData = exp.results.voltageProfile.map(p => p.voltage);
                    const isDark = document.body.classList.contains('dark');

                    const plotData = [{
                        x: xData, y: yData, mode: 'lines', name: 'Voltage Profile',
                        line: { color: isDark ? '#82e0aa' : '#2ecc71', width: 2 }, hoverinfo: 'x+y'
                    }];
                    const plotLayout = {
                        title: { text: `Voltage Profile (ID: ${exp.id})`, font: { color: isDark ? '#e2e8f0' : '#1a202c', size: 14 } },
                        xaxis: { title: 'Distance (km)', tickfont: { color: isDark ? '#e2e8f0' : '#1a202c' }, gridcolor: isDark ? '#4a5568' : '#e2e8f0', linecolor: isDark ? '#4a5568' : '#e2e8f0' },
                        yaxis: { title: 'Voltage (kV)', tickfont: { color: isDark ? '#e2e8f0' : '#1a202c' }, gridcolor: isDark ? '#4a5568' : '#e2e8f0', linecolor: isDark ? '#4a5568' : '#e2e8f0' },
                        paper_bgcolor: isDark ? '#2d3748' : '#ffffff', plot_bgcolor: isDark ? '#2d3748' : '#ffffff',
                        margin: { t: 30, b: 30, l: 40, r: 10 }, height: 256, responsive: true
                    };
                    Plotly.newPlot(chartDivId, plotData, plotLayout, { responsive: true });
                } else { // Insulator
                    const comparisonDiscStringDiv = document.getElementById(`comparisonDiscString-${exp.id}`);
                    renderComparisonDiscString(exp.results.voltages, exp.params.n, comparisonDiscStringDiv, exp.results.discPuncturedStatus);

                    const chartDivId = `compChart-${exp.id}`;
                    const labels = Array.from({ length: exp.params.n }, (_, i) => `Disc ${i + 1}`);
                    const data = [{
                        x: labels, y: exp.results.voltages, type: 'bar', name: `Voltage (kV) for Run ${exp.id}`,
                        marker: { color: document.body.classList.contains('dark') ? '#66b2ff' : '#3498db' }
                    }];
                    const layout = {
                        title: `Voltage Distribution (Run ${exp.id})`, xaxis: { title: 'Disc Number (Line End)' },
                        yaxis: { title: 'Voltage (kV)', rangemode: 'tozero' },
                        height: 250, margin: { t: 40, b: 40, l: 40, r: 20 },
                        paper_bgcolor: document.body.classList.contains('dark') ? '#2d3748' : '#ffffff',
                        plot_bgcolor: document.body.classList.contains('dark') ? '#2d3748' : '#ffffff',
                        font: { color: document.body.classList.contains('dark') ? '#e0e0e0' : '#333' }
                    };
                    Plotly.newPlot(chartDivId, data, layout, { responsive: true });
                }
            });
        }

        function renderComparisonDiscString(voltages, n, targetElement, puncturedStatus = {}) {
            targetElement.innerHTML = '';
            const V_total_current = parseFloat(insulatorTotalVoltageInput.value);

            const healthyVoltagesForMax = voltages.filter((v, idx) => !puncturedStatus[idx + 1]);
            const maxHealthyVoltage = healthyVoltagesForMax.length > 0 ? Math.max(...healthyVoltagesForMax) : 1;
            const baseAnimationDuration = 2;

            for (let i = n - 1; i >= 0; i--) {
                const disc = document.createElement('div');
                disc.className = 'disc';
                const currentDiscNumberFromLineEnd = i + 1;
                
                if (puncturedStatus[currentDiscNumberFromLineEnd]) {
                    disc.classList.add('punctured');
                }

                const v_disc = voltages[i];
                const normalizedVoltage = (v_disc / V_total_current) * 1.5;
                const hue = 240 - (normalizedVoltage * 120);
                const saturation = 100;
                const lightness = 40 + (normalizedVoltage * 30);

                if (!disc.classList.contains('punctured')) {
                    disc.style.backgroundColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                    disc.style.borderColor = `hsl(${hue}, ${saturation}%, ${lightness - 10}%)`;
                    disc.style.color = (lightness < 50) ? 'white' : '#333';
                }

                disc.innerHTML = `${v_disc.toFixed(1)}<br><span class="unit">kV</span>`;
                disc.title = `Disc ${currentDiscNumberFromLineEnd}\nVoltage: ${v_disc.toFixed(2)} kV`;
                targetElement.appendChild(disc);

                if (i > 0) {
                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svg.setAttribute("class", "connector-svg");
                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    path.setAttribute("d", "M0 45 C 10 35, 10 55, 20 45");
                    path.setAttribute("class", "connector-path");
                    svg.appendChild(path);
                    targetElement.appendChild(svg);
                }
            }
        }

        function populateCompareRunsSelect() {
            compareRunsSelect.innerHTML = '';
            const insulatorRuns = experimentHistory.filter(e => e.type === 'insulator');

            if (insulatorRuns.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No insulator experiments logged yet';
                option.disabled = true;
                compareRunsSelect.appendChild(option);
                plotComparisonChartBtn.disabled = true;
                return;
            }
            plotComparisonChartBtn.disabled = false;

            insulatorRuns.forEach(entry => {
                const option = document.createElement('option');
                option.value = entry.id;
                option.textContent = `Run ${entry.id}: n=${entry.params.n}, V=${entry.params.V}kV, Eff=${entry.results.efficiency}%`;
                compareRunsSelect.appendChild(option);
            });
        }

        function renderComparisonVoltageChart() {
            const selectedIds = Array.from(compareRunsSelect.selectedOptions).map(option => parseInt(option.value));
            const selectedExperiments = experimentHistory.filter(exp => selectedIds.includes(exp.id) && exp.type === 'insulator');

            if (selectedExperiments.length === 0) {
                showAlert("Please select at least one insulator experiment to plot for comparison.");
                Plotly.purge('comparisonVoltageChart');
                comparisonVoltagePlotlyChart = null;
                return;
            }

            const traces = [];
            const colors = [
                '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
                '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'
            ];
            const darkColors = [
                '#66b2ff', '#ffaa66', '#85e085', '#ff9999', '#c299ff',
                '#a67c6b', '#ffb3e6', '#cccccc', '#e0e066', '#66ccff'
            ];
            const isDark = document.body.classList.contains('dark');

            const maxN = Math.max(...selectedExperiments.map(e => e.params.n));

            selectedExperiments.forEach((exp, index) => {
                const labels = Array.from({ length: maxN }, (_, i) => `Disc ${i + 1}`);
                
                const paddedVoltages = [...exp.results.voltages];
                while (paddedVoltages.length < maxN) {
                    paddedVoltages.push(null);
                }

                traces.push({
                    x: labels,
                    y: paddedVoltages,
                    type: 'bar',
                    name: `Run ${exp.id} (n=${exp.params.n}, Eff: ${exp.results.efficiency}%)`,
                    marker: { color: isDark ? darkColors[index % darkColors.length] : colors[index % colors.length] },
                    hoverinfo: 'name+y'
                });
            });

            const layout = {
                barmode: 'group',
                title: 'Comparative Insulator Voltage Distribution Across Experiments',
                xaxis: { title: 'Disc Number (from Line End)', automargin: true },
                yaxis: { title: 'Voltage (kV)', rangemode: 'tozero' },
                paper_bgcolor: isDark ? '#2d3748' : '#ffffff',
                plot_bgcolor: isDark ? '#2d3748' : '#ffffff',
                font: { color: isDark ? '#e2e8f0' : '#333' },
                margin: { t: 60, b: 40, l: 50, r: 20 },
                height: 384,
                responsive: true
            };

            Plotly.newPlot('comparisonVoltageChart', traces, layout, { responsive: true }).then((gd) => {
                comparisonVoltagePlotlyChart = gd;
            });
        }


        // --- Global Actions ---
        function takeScreenshot() {
            showLoading();
            setTimeout(() => {
                const activeTabPanel = document.querySelector('.tab-panel.active');
                if (!activeTabPanel) {
                    showAlert("No active tab to screenshot.");
                    hideLoading();
                    return;
                }
                html2canvas(activeTabPanel, {
                    scale: 1.5,
                    useCORS: true,
                    backgroundColor: (document.body.classList.contains('dark') ? '#1e1e1e' : '#f4f7f6')
                })
                .then(canvas => {
                    const link = document.createElement('a');
                    link.download = `simulation_screenshot_${currentActiveTab}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    hideLoading();
                }).catch(err => {
                    console.error("Screenshot failed:", err);
                    showAlert("Could not take screenshot. Please try again.");
                    hideLoading();
                });
            }, 100);
        }

        function printCurrentView() {
            window.print();
        }

        // --- Tab Navigation ---
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-panel");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.add("hidden");
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).classList.remove("hidden");
            document.getElementById(tabName).classList.add("active");
            if (evt) {
                evt.currentTarget.classList.add("active");
            } else {
                const buttons = document.querySelectorAll('.tab-button');
                buttons.forEach(button => {
                    if (button.textContent.includes(tabName === 'ferrantiEffect' ? 'Ferranti Effect' :
                                                    tabName === 'insulatorSimulation' ? 'Insulator Voltage Distribution' :
                                                    tabName === 'experimentHistory' ? 'Experiment History' :
                                                    tabName === 'analyticsDashboard' ? 'Analytics Dashboard' :
                                                    'Comparison View')) {
                        button.classList.add('active');
                    }
                });
            }
            currentActiveTab = tabName;

            // Re-render Plotly charts when their tab becomes active
            if (tabName === 'analyticsDashboard') {
                setTimeout(updateAnalyticsDashboard, 100);
            } else if (tabName === 'comparisonView') {
                setTimeout(renderComparisonView, 100);
            } else if (tabName === 'ferrantiEffect' && ferrantiSimStep === 5 && currentFerrantiSimulationResults) {
                setTimeout(() => renderFerrantiVoltageProfileChart(currentFerrantiSimulationResults.voltageProfile, currentFerrantiSimulationResults.params.l), 100);
            } else if (tabName === 'insulatorSimulation') {
                setTimeout(calculateInsulatorVoltageDistribution, 100);
            }
        }

        // --- Event Listeners ---
        // Ferranti Effect
        document.getElementById('ferrantiStartExperimentBtn').addEventListener('click', () => advanceFerrantiSimStep(1));
        document.getElementById('ferrantiParamsToReviewBtn').addEventListener('click', () => advanceFerrantiSimStep(2));
        document.getElementById('ferrantiReviewToTheoryBtn').addEventListener('click', () => advanceFerrantiSimStep(3));
        document.getElementById('ferrantiReviewToParamsBtn').addEventListener('click', () => advanceFerrantiSimStep(1));
        document.getElementById('ferrantiTheoryToUserCalcBtn').addEventListener('click', () => advanceFerrantiSimStep(4));
        document.getElementById('ferrantiTheoryToReviewBtn').addEventListener('click', () => advanceFerrantiSimStep(2));
        document.getElementById('ferrantiCheckUserCalculationBtn').addEventListener('click', checkFerrantiUserCalculation);
        document.getElementById('ferrantiSkipCalculationBtn').addEventListener('click', () => advanceFerrantiSimStep(5));
        document.getElementById('ferrantiUserCalcToSimulateBtn').addEventListener('click', () => advanceFerrantiSimStep(5));
        document.getElementById('ferrantiResultsToAnalysisBtn').addEventListener('click', () => advanceFerrantiSimStep(6));
        document.getElementById('ferrantiAnalysisToParamsBtn').addEventListener('click', () => advanceFerrantiSimStep(1));
        document.getElementById('ferrantiLoadDefaultParamsBtn').addEventListener('click', resetFerrantiInputParameters);
        document.getElementById('ferrantiResetGlobalBtn').addEventListener('click', resetFerrantiSimulationFlow);
        document.getElementById('ferrantiSaveExperimentBtn').addEventListener('click', () => logExperiment('ferranti', {
            l: parseFloat(lineLengthInput.value), R_per_km: parseFloat(resistanceInput.value), L_per_km: parseFloat(inductanceInput.value), C_per_km: parseFloat(capacitanceInput.value), f: parseFloat(frequencyInput.value), Vs_mag_kV: parseFloat(sendingVoltageInput.value), loadCondition: loadConditionSelect.value, shuntReactorXL: parseFloat(shuntReactorXLInput.value)
        }, {
            Vs_mag_kV: currentFerrantiSimulationResults.Vs_mag_kV, Vr_mag_kV: currentFerrantiSimulationResults.Vr_mag_kV, voltageRise: currentFerrantiSimulationResults.voltageRise, Is_mag_A: currentFerrantiSimulationResults.Is_mag_A, Ir_mag_A: currentFerrantiSimulationResults.Ir_mag_A, voltageProfile: currentFerrantiSimulationResults.voltageProfile
        }, ferrantiUserCalculatedVr, ferrantiUserCalculatedRise, "(Manual save Ferranti run)"));


        // Insulator Simulation
        insulatorNumDiscsInput.addEventListener('input', calculateInsulatorVoltageDistribution);
        insulatorTotalVoltageInput.addEventListener('input', calculateInsulatorVoltageDistribution);
        insulatorCsInput.addEventListener('input', calculateInsulatorVoltageDistribution);
        insulatorCmInput.addEventListener('input', calculateInsulatorVoltageDistribution);
        insulatorMaterialSelect.addEventListener('change', updateCapacitanceBasedOnMaterial);
        pollutionLevelSelect.addEventListener('change', calculateInsulatorVoltageDistribution);
        humidityInput.addEventListener('input', calculateInsulatorVoltageDistribution);
        document.getElementById('insulatorCalculateBtn').addEventListener('click', calculateInsulatorVoltageDistribution);
        document.getElementById('insulatorLoadDefaultParamsBtn').addEventListener('click', resetInsulatorInputParameters);
        document.getElementById('insulatorSaveExperimentBtn').addEventListener('click', () => logExperiment('insulator', {
            n: parseInt(insulatorNumDiscsInput.value), V: parseFloat(insulatorTotalVoltageInput.value), Cs: parseFloat(insulatorCsInput.value), Cm: parseFloat(insulatorCmInput.value), insulatorMaterial: insulatorMaterialSelect.value, pollutionLevel: pollutionLevelSelect.value, humidity: parseFloat(humidityInput.value), faultVoltage: parseFloat(modalFaultVoltageInput.value), faultDuration: parseFloat(modalFaultDurationInput.value), faultyDiscIndex: parseInt(modalFaultyDiscIndexInput.value)
        }, {
            voltages: insulatorCalculatedVoltages.map(v => parseFloat(v.toFixed(2))), efficiency: insulatorCalculatedEfficiency, maxDiscVoltage: insulatorCalculatedVoltages.length > 0 ? parseFloat(Math.max(...insulatorCalculatedVoltages).toFixed(2)) : 0, discPuncturedStatus: JSON.parse(JSON.stringify(discPuncturedStatus))
        }, null, null, "(Manual save Insulator run)"));
        document.getElementById('insulatorResetGlobalBtn').addEventListener('click', () => {
            showConfirm("Are you sure you want to reset the entire Insulator simulation flow? All current inputs will be cleared.", () => {
                resetInsulatorInputParameters();
                calculateInsulatorVoltageDistribution(); // Re-render with defaults
                showAlert("Insulator simulation reset to defaults.");
            });
        });

        // Insulator Design Mode
        toggleDesignModeBtn.addEventListener('click', toggleDesignMode);
        calculateDesignBtn.addEventListener('click', calculateRequiredDiscs);

        // Insulator Fault Settings
        openFaultSettingsBtn.addEventListener('click', openFaultSettingsModal);
        saveFaultSettingsBtn.addEventListener('click', saveFaultSettings);
        modalFaultyDiscIndexInput.addEventListener('input', () => { // Update max based on current discs
            modalFaultyDiscIndexInput.max = parseInt(insulatorNumDiscsInput.value);
            if (parseInt(modalFaultyDiscIndexInput.value) > parseInt(insulatorNumDiscsInput.value)) {
                modalFaultyDiscIndexInput.value = insulatorNumDiscsInput.value;
            }
        });
        modalFaultVoltageInput.addEventListener('input', calculateInsulatorVoltageDistribution); // Live update fault visual
        modalFaultDurationInput.addEventListener('input', calculateInsulatorVoltageDistribution); // Live update fault visual
        modalFaultyDiscIndexInput.addEventListener('input', calculateInsulatorVoltageDistribution); // Live update fault visual

        // Insulator Disc Properties
        saveDiscPropertiesBtn.addEventListener('click', saveDiscProperties);
        
        // Insulator Voltage Flow Animation
        toggleVoltageFlowBtn.addEventListener('click', toggleVoltageFlowAnimation);

        // Unified History & Analytics
        document.getElementById('saveWithNoteBtn').addEventListener('click', saveCurrentConfigWithNote);
        document.getElementById('exportCsvBtn').addEventListener('click', exportHistoryToCSV);
        document.getElementById('clearHistoryBtn').addEventListener('click', clearAllHistory);
        plotComparisonChartBtn.addEventListener('click', renderComparisonVoltageChart);

        // Global Utility Buttons
        document.getElementById('screenshotBtnGlobal').addEventListener('click', takeScreenshot);
        document.getElementById('printBtnGlobal').addEventListener('click', printCurrentView);

        darkModeToggle.addEventListener('change', toggleDarkMode);

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            applyDarkModeOnLoad();
            loadHistoryFromLocalStorage();
            updateHistoryTable();
            updateAnalyticsDashboard();
            updatePersonalizedFeedback();
            // Initialize Ferranti tab
            updateFerrantiSimulationStepUI();
            // Initialize Insulator tab with default calculation
            calculateInsulatorVoltageDistribution();
            openTab(null, 'ferrantiEffect'); // Ensure Ferranti tab is active on load
        });
    </script>
</body>
</html>
